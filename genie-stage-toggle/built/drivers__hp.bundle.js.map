{"version":3,"sources":["webpack:///./src/inject/drivers/base.js","webpack:///./src/inject/drivers/hp/_base.js","webpack:///./src/inject/drivers/hp/canon.com.js","webpack:///./src/inject/drivers/hp/davidsbridal.com.js","webpack:///./src/inject/drivers/hp/estore.canon.ca.js","webpack:///./src/inject/drivers/hp/hp.com.js","webpack:///./src/inject/drivers/hp/index.js","webpack:///./src/inject/drivers/hp/petco.com.js"],"names":["toFloat","format","BaseDriver","watchForRestoreUserData","time","pauseInterval","interval","setInterval","currentState","checkRestoreDataCondition","clearInterval","bus","$emit","e","handleDriverError","source","storeUserData","domain","userData","getUserData","Promise","resolve","userDataKey","getUserDataStorageKey","storageRecord","storedTime","Date","now","backgroundMessaging","setDriverStorage","log","restoreUserData","maxStorageLifetime","driverStorage","getDriverStorage","deleteDriverStorage","setUserData","getStartPrice","startPrice","Number","MAX_SAFE_INTEGER","totalElementConfig","TOTAL_ELEMENT_CONFIG","selector","attribute","regex","totalElement","Array","isArray","forEach","elemSelector","document","querySelector","Error","value","getAttribute","textContent","pattern","group","match","beforeTestCodes","beforeCheckCodes","beforeApplyCodes","checkCodes","applyCodes","stackCodes","removeCodes","getMerchantCodes","getExistingCodes","codes","codeCount","getPreTaxShippingTotal","watchForCartUrl","previousState","checkCondition","completeExperience","completeExperiencePromisified","args","_promisify","beforeTestCodesPromisified","getStartPricePromisified","getMerchantCodesPromisified","getExistingCodesPromisified","removeCodesPromisified","beforeApplyCodesPromisified","applyCodesPromisified","beforeCheckCodesPromisified","checkCodesPromisified","stackCodesPromisified","method","then","apply","elemToFloat","extractElementFromHTML","DOM","Driver","constructor","BASE_URL","TOTAL_SELECTOR","CHECKOUT_TOTAL_SELECTOR","APPLIED_CODES_SELECTOR","APPLY_FORM","IS_STACKABLE","APPLY_WITH_MANAGE_CODE_URL","APPROVAL_REQUEST_PARAMS","URLSearchParams","set","orderIDElement","ORDER_ID","_applyCode","originalPrice","parseTotal","workingDiscounts","each","code","responseObject","errorCode","finalPrice","finalDiscount","isValid","getUpdatedCart","html","result","push","_removeCode","map","discount","discounts","validationInfo","sort","a","b","currentPrice","currentDiscount","successfulCodes","_parseResponse","responseText","JSON","parse","replace","trim","_getUrl","isApply","params","_manageCode","_getManageCodeParams","get","url","body","fetch","credentials","headers","response","text","makeApprovalRequest","window","location","href","toInt","extractElement","extractFormValues","extractData","Hp","APPLY_FORM_SELECTOR","BASKET_COUNT_SELECTOR","APPLIED_CODES_REGEXP","ITEM_QUANTITY_REGEXP","STORE_ID_SELECTOR","CATALOG_ID_SELECTOR","LANG_ID_SELECTOR","SHIPPING_SELECTOR","MINI_SHOP_REQUEST_BODY_PARAMS","MINI_SHOP_REQUEST_PARAMS","querySelectorAll","element","length","originalItemsCount","_parseItemsCount","freeGifts","Boolean","currentFreeGifts","_deleteCartCookie","_getUpdatedCart","responseHTML","total","shipping","calculatedShipping","toLowerCase","includes","toString","data","reduce","count","el","i","name","stackable","maxCoupons","isOnCartUrl","hrefToLowerCase","startsWith","isCartEmpty","isCheckoutPage","TAX_SELECTOR","CODE_INPUT_SELECTOR","EMPTY_CART_SELECTOR","SHIPPING_FORM_SELECTOR","PROPOSE_CODES_SELECTOR","PAGE_CODES_SELECTOR","PAGE_CODE_REGEX","MERCHANT_CODE_REGEX","isOnRightURL","emptyCartEl","isOnShipping","pageCodes","filter","pageCodesUnique","Set","_getProposedCoupons","proposedCodes","split","tax","isSinglePageApp","FORM_SELECTOR","APPLIED_CODES_REG","APPLIED_CODE_SELECTOR","SPINNER_SELECTOR","spinner","isSpinner","offsetParent","isPromoInput","ORDER_ID_SELECTOR","LOADING_ELEMENT_SELECTOR","INPUT_CODE_SELECTOR_ON_CART","IS_LOYALTY_SELECTOR","SHIPPING_REGEX","onCartEl","onCartCond","loadingEl","loadingCond","classList","contains","BODY_DATA","orderId","langId","storeId","catalogId","REMOVE_FORM","isLoyaltyEl","isLoyaltyEligible","finalView","loyaltyAmt","dataset","cpn","shippingEl","nextElementSibling","canon","davidsbridal","estoreCanon","hp","petco","IS_CHECKOUT","PROMO_SELECTOR","EMPTY_CRT_SELECTOR","NEWRELIC_ID_REGEX","NEWRELIC_ID","APPLY_BUTTON_SELECTOR","updateBodyData","beginIndex","fromPage","objectId","requesttype","shippingUpdateData","INDEX_SELECTOR","VALUE_SELECTOR","TOTAL_PRICE_REGEXP","MERCHANT_CODE_SELECTOR","promoInput","isOnRightUrl","isCodeApplied","calculationUsage","find","resHtml","item","getUpdatedData","sendXhr","regExpTotal","getValue","regEx","index","test","indexOf","totalValue","taxValue","shippingValue","donation","updatedShipping"],"mappings":"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","file":"drivers__hp.bundle.js","sourcesContent":["import bus from '../bus';\nimport { log, format } from '../../utils';\nimport { backgroundMessaging, handleDriverError } from '../lib';\n\nconst { toFloat } = format;\n\nexport default class BaseDriver {\n\t/**\n\t * @function watchForRestoreUserData - set up a listener to check user data restorement\n\t * @emits bus#RestoreUserData - the event that indicates to the app\tthat user data could be restored\n\t */\n\twatchForRestoreUserData(time = 500) {\n\t\tlet pauseInterval = false;\n\t\tconst interval = setInterval(async () => {\n\t\t\tif (!pauseInterval) {\n\t\t\t\ttry {\n\t\t\t\t\t// Pause interval to avoid triggering multiple times `checkCondition`\n\t\t\t\t\t// before the response will be received\n\t\t\t\t\tpauseInterval = true;\n\t\t\t\t\tconst currentState = await this.checkRestoreDataCondition();\n\t\t\t\t\tpauseInterval = false;\n\t\t\t\t\tif (currentState) {\n\t\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\t\tbus.$emit('restore-user-data');\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\thandleDriverError(e, { source: 'checkRestoreDataCondition' });\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t}\n\t\t\t}\n\t\t}, time);\n\n\t\treturn interval;\n\t}\n\n\tcheckRestoreDataCondition() {\n\t\treturn false;\n\t}\n\n\t/**\n\t * @function storeUserData\n\t * @param {String} domain - domain to set the driver storage\n\t * @returns {Promise}\n\t */\n\tasync storeUserData(domain) {\n\t\tconst userData = await this.getUserData();\n\n\t\tif (userData === null) {\n\t\t\t// Nothing to store\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\tconst userDataKey = this.getUserDataStorageKey(domain);\n\t\tconst storageRecord = {\n\t\t\tuserData,\n\t\t\tstoredTime: Date.now(),\n\t\t};\n\t\tbackgroundMessaging.setDriverStorage(userDataKey, storageRecord);\n\t\tlog('Stored user data: %O', storageRecord);\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function restoreUserData\n\t * @param {String} domain - domain to access the driver storage\n\t * @param {Number} [maxStorageLifetime] - optional, the lifetime of the stored data (default 10 mins)\n\t * @returns {Promise}\n\t */\n\tasync restoreUserData(domain, maxStorageLifetime = 600000) {\n\t\tconst userDataKey = this.getUserDataStorageKey(domain);\n\t\tconst driverStorage = await backgroundMessaging.getDriverStorage(userDataKey);\n\n\t\tif (driverStorage) {\n\t\t\tconst { storedTime, userData } = driverStorage;\n\t\t\t// Clear stored user data\n\t\t\tbackgroundMessaging.deleteDriverStorage(userDataKey);\n\n\t\t\tif (Date.now() - storedTime <= maxStorageLifetime) {\n\t\t\t\tlog('Restore user data: %O', userData);\n\t\t\t\treturn this.setUserData(userData);\n\t\t\t}\n\t\t\tlog('User data is outdated, skip restoring');\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function getUserData - get user data which should be stored\n\t * @returns {Object} - object with required user data which should be restored\n\t */\n\tgetUserData() {\n\t\treturn null;\n\t}\n\n\t/**\n\t * @function setUserData - restore user data on page\n\t * @param {Object} userData - data which was saved and should be restored\n\t * @returns {Promise}\n\t */\n\tsetUserData() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function getUserDataStorageKey - unique key for storing user data per merchant\n\t * @returns {String}\n\t */\n\tgetUserDataStorageKey(domain) {\n\t\t// Append `_userData` to avoid possible conflicts with created storage from driver\n\t\treturn `${domain}_userData`;\n\t}\n\n\t/**\n\t * Parses start price from page\n\t *\n\t * @function getStartPrice\n\t * @returns {Promise<Number>|Number} - the total from the page\n\t */\n\tgetStartPrice() {\n\t\tlet startPrice = Number.MAX_SAFE_INTEGER;\n\t\tconst totalElementConfig = this.TOTAL_ELEMENT_CONFIG;\n\t\tif (totalElementConfig) {\n\t\t\tconst { selector, attribute, regex } = totalElementConfig;\n\t\t\tlet totalElement;\n\t\t\t// handle case, when there is array of selectors and we try to take totalElement using these selectors in turn\n\t\t\t// for example dell.com, hertz.com\n\t\t\tif (Array.isArray(selector)) {\n\t\t\t\tselector.forEach(elemSelector => {\n\t\t\t\t\tif (!totalElement) {\n\t\t\t\t\t\ttotalElement = document.querySelector(elemSelector);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (typeof selector === 'string') {\n\t\t\t\ttotalElement = document.querySelector(selector);\n\t\t\t} else {\n\t\t\t\thandleDriverError(\n\t\t\t\t\tnew Error(`Total selector type mismatch. Expected string | array, got ${typeof selector}`),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (totalElement) {\n\t\t\t\tlet value = attribute ? totalElement.getAttribute(attribute) : totalElement.textContent;\n\n\t\t\t\tif (value && regex) {\n\t\t\t\t\t// Set pattern to null to receive error in case pattern was not defined\n\t\t\t\t\t// otherwise we may silently return undefined or empty string\n\t\t\t\t\tconst { pattern = null, group = 0 } = regex;\n\t\t\t\t\tvalue = value.match(pattern)[group];\n\t\t\t\t}\n\t\t\t\tstartPrice = toFloat(value);\n\t\t\t}\n\t\t}\n\t\treturn startPrice;\n\t}\n\n\t/**\n\t * Perform any needed actions and setup to start codes testing\n\t *\n\t * @function beforeTestCodes\n\t *\n\t * @returns {Promise}\n\t */\n\tbeforeTestCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @typedef {Object} OriginalData\n\t * @property {Number} originalPrice the starting price for the cart\n\t * @property {Number} originalItemsCount the starting items count of the cart\n\t */\n\t/**\n\t * Perform any needed actions and setup before `checkCodes()` will be executed\n\t *\n\t * @function beforeCheckCodes\n\t * @param {Number} [originalPrice] - optional, the starting price for the cart\n\t * @param {Number} [originalItemsCount] - optional, the starting items count of the cart\n\t * @returns {Promise.<Number>|Promise.<OriginalData>} - optional, a promise which resolves to the original price of the cart\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\t\tor original data which includes originalItemsCount as well\n\t */\n\tbeforeCheckCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Perform any needed actions and setup before `applyCodes()` will be executed\n\t *\n\t * @function beforeApplyCodes\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tbeforeApplyCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function checkCodes\n\t *\n\t * @param {String[]} codes\n\t * @param {Number} [originalPrice] - optional, the starting price for the cart\n\t * @param {Number} [originalItemsCount] - optional, the starting items count of the cart\n\t * @returns {Promise}\n\t */\n\tcheckCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Takes each code in @param codes and actually applies it to the cart,\n\t * typically through a fetch(...) call.\n\t *\n\t * @function applyCodes\n\t *\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tapplyCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function stackCodes\n\t *\n\t * @param {Object} validationInfo - contains all required info passed by `checkCodes()` for codes stacking\n\t * @param {String[]} validationInfo.codes\n\t * @param {Float} [validationInfo.originalPrice]\n\t * @param {Object[]} [validationInfo.discounts] - contains all codes mapped with their discounts\n\t * @returns {Promise}\n\t */\n\tstackCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function removeCodes\n\t *\n\t * @param {String[]} codes - passed in case the driver needs to know specific codes to do removal\n\t * @returns {Promise.<Number>|Promise.<OriginalData>} - optional, a promise which resolves to the original price of the cart\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\t\tor original data which includes originalItemsCount as well\n\t */\n\tremoveCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Takes codes from merchant page (or request response) which are available and were not applied by user\n\t *\n\t * @function getMerchantCodes\n\t * @returns {String[]} - codes from merhcant page (or request response if possible)\n\t */\n\tgetMerchantCodes() {\n\t\treturn [];\n\t}\n\n\t/**\n\t * Takes codes from merchant page (or request) which are available and were applied by user\n\t *\n\t * @typedef {Object} ExistingCodeInfo\n\t * @prop {String[]} codes - list of codes which had been applied, if discoverable\n\t * @prop {Number} codeCount - the number of codes that were applied to the cart\n\t */\n\t/**\n\t * @function getExistingCodes\n\t * @returns {ExistingCodeInfo}\n\t */\n\tgetExistingCodes() {\n\t\treturn {\n\t\t\tcodes: [],\n\t\t\tcodeCount: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Parses pre tax and shipping total from page or request's response\n\t *\n\t * @function getPreTaxShippingTotal\n\t * @returns {Promise<Number>|Number} - the total without tax and shipping\n\t */\n\tgetPreTaxShippingTotal() {\n\t\treturn null;\n\t}\n\n\t/**\n\t * @function watchForCartUrl - optional function to set up a listener for url changes on SPAs\n\t * @emits bus#CartActive - the event (using the string 'cart-active') that indicates to the app that test codes button should be shown\n\t * @emits bus#CartInactive - the event (using the string 'cart-inactive') that indicates to the app that test codes button should be hidden\n\t */\n\twatchForCartUrl(time = 500) {\n\t\tlet previousState = null;\n\t\tlet pauseInterval = false;\n\n\t\tconst interval = setInterval(async () => {\n\t\t\tif (!pauseInterval) {\n\t\t\t\tlet currentState = null;\n\t\t\t\ttry {\n\t\t\t\t\t// Pause interval to avoid triggering multiple times `checkCondition`\n\t\t\t\t\t// before the response will be received\n\t\t\t\t\tpauseInterval = true;\n\t\t\t\t\tcurrentState = await this.checkCondition();\n\t\t\t\t\tpauseInterval = false;\n\t\t\t\t} catch (e) {\n\t\t\t\t\thandleDriverError(e, { source: 'checkCondition' });\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t}\n\t\t\t\tif (currentState !== previousState) {\n\t\t\t\t\tbus.$emit(currentState ? 'cart-active' : 'cart-inactive');\n\t\t\t\t}\n\t\t\t\tpreviousState = currentState;\n\t\t\t}\n\t\t}, time);\n\t\t// return the interval to stop it in `watchForCartUrl` if needed from outside\n\t\treturn interval;\n\t}\n\n\t/**\n\t * @function checkCondition - optional function to check for conditions on SPAs\n\t * @returns {Boolean}\n\t */\n\tcheckCondition() {\n\t\treturn false;\n\t}\n\n\t/**\n\t * Perform custom completion action on Continue to Checkout button\n\t * Takes best codes in @param codes\n\t *\n\t * @function completeExperience\n\t *\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tcompleteExperience() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function completeExperiencePromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tcompleteExperiencePromisified(...args) {\n\t\treturn this._promisify(this.completeExperience, args);\n\t}\n\n\t/**\n\t * @function beforeCodesTestingPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeTestCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeTestCodes, args);\n\t}\n\n\t/**\n\t * @function getStartPricePromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetStartPricePromisified() {\n\t\treturn this._promisify(this.getStartPrice);\n\t}\n\n\t/**\n\t * @function getMerchantCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetMerchantCodesPromisified(...args) {\n\t\treturn this._promisify(this.getMerchantCodes, args);\n\t}\n\n\t/**\n\t * @function getExistingCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetExistingCodesPromisified(...args) {\n\t\treturn this._promisify(this.getExistingCodes, args);\n\t}\n\n\t/**\n\t * @function removeCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tremoveCodesPromisified(...args) {\n\t\treturn this._promisify(this.removeCodes, args);\n\t}\n\n\t/**\n\t * @function beforeApplyCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeApplyCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeApplyCodes, args);\n\t}\n\n\t/**\n\t * @function applyCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tapplyCodesPromisified(...args) {\n\t\treturn this._promisify(this.applyCodes, args);\n\t}\n\n\t/**\n\t * @function beforeCheckCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeCheckCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeCheckCodes, args);\n\t}\n\n\t/**\n\t * @function checkCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tcheckCodesPromisified(...args) {\n\t\treturn this._promisify(this.checkCodes, args);\n\t}\n\n\t/**\n\t * @function stackCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tstackCodesPromisified(...args) {\n\t\treturn this._promisify(this.stackCodes, args);\n\t}\n\n\t/**\n\t * @function _promisify - promisifies given method and return it's result as a Promise\n\t * @returns {Promise}\n\t */\n\t_promisify(method, args) {\n\t\treturn Promise.resolve().then(() => method.apply(this, args));\n\t}\n}\n","import Promise from 'bluebird';\nimport BaseDriver from '../base';\nimport bus from '../../bus';\nimport { format, DOM, log } from '../../../utils';\n\nconst { elemToFloat } = format;\nconst { extractElementFromHTML } = DOM;\n\nexport default class Driver extends BaseDriver {\n\tconstructor() {\n\t\tsuper();\n\t\t// Initialize base url (will be used as base url of requests)\n\t\tthis.BASE_URL = '';\n\t\t// Initialize selectors\n\t\tthis.TOTAL_SELECTOR = '';\n\t\tthis.CHECKOUT_TOTAL_SELECTOR = '';\n\t\tthis.APPLIED_CODES_SELECTOR = '';\n\t\t// Initialize apply form (just use extractFormValues to rewrite with your data)\n\t\tthis.APPLY_FORM = null;\n\t\t// Rewrite with true if your merchant has stackable driver\n\t\tthis.IS_STACKABLE = false;\n\t\t// Rewrite with false if your merchant use separate urls for apply and remove\n\t\tthis.APPLY_WITH_MANAGE_CODE_URL = true;\n\n\t\t// default params for approval request\n\t\tthis.APPROVAL_REQUEST_PARAMS = new URLSearchParams();\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('orderId', '.');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('calculationUsage', '-1,-2,-5,-6,-7');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('requesttype', 'ajax');\n\t\t// Initialize order id\n\t\tconst orderIDElement = document.querySelector('input[name=\"orderId\"]');\n\t\tthis.ORDER_ID = orderIDElement ? orderIDElement.value : null;\n\t}\n\n\tapplyCodes(codes) {\n\t\tif (this.IS_STACKABLE) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\treturn this._applyCode(codes[0]);\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\n\t\tconst workingDiscounts = [];\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis._applyCode(code).then(responseObject => {\n\t\t\t\t// no need to get updated cart or remove code if apply returned error\n\t\t\t\tif (responseObject.errorCode) {\n\t\t\t\t\treturn bus.$emit('code-checked', {\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tfinalPrice: originalPrice,\n\t\t\t\t\t\tfinalDiscount: 0,\n\t\t\t\t\t\tisValid: false,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedCart().then(html => {\n\t\t\t\t\tconst finalPrice = this.parseTotal(html);\n\t\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\t\t\t\t\tconst result = { code, finalPrice, finalDiscount, isValid: true };\n\t\t\t\t\tif (this.IS_STACKABLE && finalPrice < originalPrice) {\n\t\t\t\t\t\tworkingDiscounts.push(result);\n\t\t\t\t\t}\n\t\t\t\t\treturn this._removeCode(code).then(() => bus.$emit('code-checked', result));\n\t\t\t\t});\n\t\t\t}),\n\t\t).then(() => {\n\t\t\tif (this.IS_STACKABLE) {\n\t\t\t\tbus.$emit('stack-codes', {\n\t\t\t\t\tcodes: workingDiscounts.map(discount => discount.code),\n\t\t\t\t\tdiscounts: workingDiscounts,\n\t\t\t\t\toriginalPrice,\n\t\t\t\t});\n\t\t\t}\n\t\t\treturn Promise.resolve();\n\t\t});\n\t}\n\n\tstackCodes(validationInfo) {\n\t\tconst { discounts, originalPrice } = validationInfo;\n\n\t\tdiscounts.sort((a, b) => b.finalDiscount - a.finalDiscount);\n\n\t\tlet currentPrice = originalPrice;\n\t\tlet currentDiscount = 0;\n\t\tconst successfulCodes = [];\n\n\t\treturn Promise.each(discounts, discount =>\n\t\t\tthis._applyCode(discount.code).then(responseObject => {\n\t\t\t\tconst result = { code: discount.code, finalPrice: currentPrice, finalDiscount: currentDiscount };\n\t\t\t\t// apply failed, no need to remove anything or check the price\n\t\t\t\tif (responseObject.errorCode) {\n\t\t\t\t\tbus.$emit('code-stacked', result);\n\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedCart().then(html => {\n\t\t\t\t\tconst finalPrice = this.parseTotal(html);\n\t\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\t\t\t\t\tresult.finalPrice = finalPrice;\n\t\t\t\t\tresult.finalDiscount = finalDiscount;\n\n\t\t\t\t\tbus.$emit('code-stacked', result);\n\n\t\t\t\t\tif (finalPrice < currentPrice) {\n\t\t\t\t\t\tsuccessfulCodes.push(discount.code);\n\t\t\t\t\t\tcurrentDiscount = finalDiscount;\n\t\t\t\t\t\tcurrentPrice = finalPrice;\n\t\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t\t}\n\t\t\t\t\treturn this._removeCode(discount.code);\n\t\t\t\t});\n\t\t\t}),\n\t\t).then(() => {\n\t\t\tbus.$emit('stackable-complete', {\n\t\t\t\tcodes: successfulCodes,\n\t\t\t\tfinalPrice: currentPrice,\n\t\t\t\tfinalDiscount: currentDiscount,\n\t\t\t});\n\t\t\treturn Promise.resolve();\n\t\t});\n\t}\n\n\t/**\n\t * Get object from response (to see if there any errors)\n\t *\n\t * @param {String} responseText\n\t * @returns {Object}\n\t * @private\n\t */\n\t_parseResponse(responseText) {\n\t\treturn JSON.parse(\n\t\t\tresponseText\n\t\t\t\t.replace('/*', '')\n\t\t\t\t.replace('*/', '')\n\t\t\t\t.trim(),\n\t\t);\n\t}\n\n\tremoveCodes(codes) {\n\t\treturn Promise.each(codes, code => this._removeCode(code))\n\t\t\t.then(() => this.getUpdatedCart())\n\t\t\t.then(html => this.parseTotal(html));\n\t}\n\n\t/**\n\t * We are supporting both combined (manageCode) and separate (applyCode/removeCode) urls\n\t * Method is used to get urls out of driver param\n\t *\n\t * @param {Boolean} isApply\n\t * @returns {string}\n\t * @private\n\t */\n\t_getUrl(isApply = true) {\n\t\tif (this.APPLY_WITH_MANAGE_CODE_URL) {\n\t\t\treturn `${this.BASE_URL}/AjaxPromotionCodeManage`;\n\t\t}\n\t\treturn `${this.BASE_URL}/${isApply ? 'AjaxRESTPromotionCodeApply' : 'AjaxRESTPromotionCodeRemove'}`;\n\t}\n\n\t_applyCode(code) {\n\t\tthis.APPLY_FORM.params.set('taskType', 'A');\n\t\treturn this._manageCode(code, this._getUrl());\n\t}\n\n\t_removeCode(code) {\n\t\tthis.APPLY_FORM.params.set('taskType', 'R');\n\t\treturn this._manageCode(code, this._getUrl(false));\n\t}\n\n\t/**\n\t * Get params for manage code request\n\t *\n\t * @param {String} code\n\t * @private\n\t */\n\t_getManageCodeParams(code) {\n\t\t// sometimes form does not contain this parameters, so we check if they are not present, we add them\n\t\tif (!this.APPLY_FORM.params.get('requesttype')) {\n\t\t\tthis.APPLY_FORM.params.set('finalView', 'AjaxOrderItemDisplayView');\n\t\t\tthis.APPLY_FORM.params.set('requesttype', 'ajax');\n\t\t\tthis.APPLY_FORM.params.set('orderId', this.ORDER_ID);\n\t\t}\n\t\tthis.APPLY_FORM.params.set('promoCode', code);\n\t\treturn this.APPLY_FORM.params;\n\t}\n\n\t_manageCode(code, url) {\n\t\tconst body = this._getManageCodeParams(code);\n\t\treturn (\n\t\t\tfetch(url, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tcredentials: 'include',\n\t\t\t\theaders: {\n\t\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t},\n\t\t\t\tbody,\n\t\t\t})\n\t\t\t\t// This request is required, otherwise coupon code won't be applied or removed\n\t\t\t\t.then(response => response.text())\n\t\t\t\t.then(responseText => {\n\t\t\t\t\tconst responseObject = this._parseResponse(responseText);\n\t\t\t\t\t// if there will be error, there is no need to make approval request\n\t\t\t\t\tif (!responseObject.errorCode) {\n\t\t\t\t\t\treturn this.makeApprovalRequest().then(() => responseObject);\n\t\t\t\t\t}\n\t\t\t\t\treturn responseObject;\n\t\t\t\t})\n\t\t);\n\t}\n\n\tmakeApprovalRequest() {\n\t\treturn fetch(`${this.BASE_URL}/AjaxOrderChangeServiceItemUpdate`, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\theaders: {\n\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t},\n\t\t\tbody: this.APPROVAL_REQUEST_PARAMS,\n\t\t});\n\t}\n\n\tgetUpdatedCart() {\n\t\treturn fetch(window.location.href, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n\n\tparseTotal(html) {\n\t\tlet totalElement = null;\n\t\tif (html) {\n\t\t\ttotalElement = extractElementFromHTML(html, this.TOTAL_SELECTOR);\n\t\t} else {\n\t\t\ttotalElement = document.querySelector(this.TOTAL_SELECTOR);\n\t\t}\n\t\treturn elemToFloat(totalElement);\n\t}\n}\n","import Promise from 'bluebird';\nimport Hp from './_base';\nimport { format, DOM, log } from '../../../utils';\nimport bus from '../../bus';\n\nconst { toInt, toFloat } = format;\nconst { extractElement, extractFormValues, extractData } = DOM;\n\n/** Behavior description:\n * - existing code: yes\n * - remove code: yes\n * - stackable: yes\n * - free gift support: yes\n * - 'isValid' implemented: yes\n * - manually apply code: no\n * - valid code can be replaced with another valid code:can't check, currently there is only one code\n * - site works very slow, so we can test only one code\n * - can run code testing only on Cart page\n * */\n\nconst BASE_URL = 'https://shop.usa.canon.com/shop';\n\nconst Driver = class Driver extends Hp {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.BASE_URL = BASE_URL;\n\t\tthis.APPLY_FORM_SELECTOR = '#PromotionCodeForm';\n\t\tthis.TOTAL_SELECTOR = '#WC_SingleShipmentOrderTotalsSummary_td_13';\n\t\tthis.IS_STACKABLE = true;\n\t\tthis.BASKET_COUNT_SELECTOR = '#minishopcart_total';\n\t\tthis.APPLIED_CODES_SELECTOR = '[id^=promotion_]';\n\t\tthis.APPLIED_CODES_REGEXP = /\"PromotionCodeForm\",\"([^\"]+)\"/;\n\t\tthis.ITEM_QUANTITY_REGEXP = /item_qtyInShopCart_/g;\n\n\t\tthis.STORE_ID_SELECTOR = 'input[name=\"storeId\"]';\n\t\tthis.CATALOG_ID_SELECTOR = 'input[name=\"catalogId\"]';\n\t\tthis.LANG_ID_SELECTOR = 'input[name=\"langId\"]';\n\n\t\tthis.SHIPPING_SELECTOR = '#WC_SingleShipmentOrderTotalsSummary_td_41';\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.APPLY_FORM = extractFormValues(this.APPLY_FORM_SELECTOR);\n\n\t\tthis.MINI_SHOP_REQUEST_BODY_PARAMS = new URLSearchParams();\n\t\tthis.MINI_SHOP_REQUEST_BODY_PARAMS.set('deleteCartCookie', true);\n\t\tthis.MINI_SHOP_REQUEST_BODY_PARAMS.set('objectId', '');\n\t\tthis.MINI_SHOP_REQUEST_BODY_PARAMS.set('requesttype', 'ajax');\n\n\t\tthis.MINI_SHOP_REQUEST_PARAMS = new URLSearchParams();\n\t\tthis.MINI_SHOP_REQUEST_PARAMS.set('storeId', document.querySelector(this.STORE_ID_SELECTOR).value);\n\t\tthis.MINI_SHOP_REQUEST_PARAMS.set('catalogId', document.querySelector(this.CATALOG_ID_SELECTOR).value);\n\t\tthis.MINI_SHOP_REQUEST_PARAMS.set('langId', document.querySelector(this.LANG_ID_SELECTOR).value);\n\n\t\treturn Promise.resolve();\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = [...document.querySelectorAll(this.APPLIED_CODES_SELECTOR)].map(\n\t\t\telement => element.getAttribute('onClick').match(this.APPLIED_CODES_REGEXP)[1],\n\t\t);\n\t\treturn {\n\t\t\tcodes,\n\t\t\tcodeCount: codes.length,\n\t\t};\n\t}\n\n\tremoveCodes(codes) {\n\t\treturn Promise.each(codes, code => this._removeCode(code))\n\t\t\t.then(() => this.getUpdatedCart())\n\t\t\t.then(html => ({\n\t\t\t\toriginalPrice: this.parseTotal(html),\n\t\t\t\toriginalItemsCount: this._parseItemsCount(html),\n\t\t\t}));\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal(), originalItemsCount = this._parseItemsCount()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\t\tlog(`Original items count: ${originalItemsCount}`);\n\t\tconst workingDiscounts = [];\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis._applyCode(code).then(responseObject => {\n\t\t\t\t// no need to get updated cart or remove code if apply returned error\n\t\t\t\tif (responseObject.errorCode) {\n\t\t\t\t\treturn bus.$emit('code-checked', {\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tfinalPrice: originalPrice,\n\t\t\t\t\t\tfinalDiscount: 0,\n\t\t\t\t\t\tisValid: false,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedCart().then(html => {\n\t\t\t\t\tconst finalPrice = this.parseTotal(html);\n\t\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\t\t\t\t\tconst freeGifts = this._parseItemsCount(html) - originalItemsCount;\n\t\t\t\t\tconst result = { code, finalPrice, finalDiscount, freeGifts };\n\t\t\t\t\tif (\n\t\t\t\t\t\tfinalPrice < originalPrice ||\n\t\t\t\t\t\t(result.finalPrice === originalPrice && Boolean(result.freeGifts))\n\t\t\t\t\t) {\n\t\t\t\t\t\tworkingDiscounts.push(result);\n\t\t\t\t\t}\n\t\t\t\t\treturn this._removeCode(code).then(() => bus.$emit('code-checked', result));\n\t\t\t\t});\n\t\t\t}),\n\t\t).then(() =>\n\t\t\tbus.$emit('stack-codes', {\n\t\t\t\tcodes: workingDiscounts.map(discount => discount.code),\n\t\t\t\tdiscounts: workingDiscounts,\n\t\t\t\toriginalPrice,\n\t\t\t\toriginalItemsCount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tstackCodes(validationInfo) {\n\t\tconst { discounts, originalPrice, originalItemsCount } = validationInfo;\n\n\t\tdiscounts.sort((a, b) => b.finalDiscount - a.finalDiscount);\n\n\t\tlet currentPrice = originalPrice;\n\t\tlet currentDiscount = 0;\n\t\tlet currentFreeGifts = 0;\n\t\tconst successfulCodes = [];\n\n\t\treturn Promise.each(discounts, discount =>\n\t\t\tthis._applyCode(discount.code).then(responseObject => {\n\t\t\t\tconst result = {\n\t\t\t\t\tcode: discount.code,\n\t\t\t\t\tfinalPrice: currentPrice,\n\t\t\t\t\tfinalDiscount: currentDiscount,\n\t\t\t\t};\n\t\t\t\t// no need to get updated cart or remove code if apply returned error\n\t\t\t\tif (responseObject.errorCode) {\n\t\t\t\t\treturn bus.$emit('code-stacked', result);\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedCart().then(html => {\n\t\t\t\t\tresult.finalPrice = this.parseTotal(html);\n\t\t\t\t\tresult.finalDiscount = originalPrice - result.finalPrice;\n\t\t\t\t\tresult.freeGifts = this._parseItemsCount(html) - originalItemsCount;\n\n\t\t\t\t\tbus.$emit('code-stacked', result);\n\n\t\t\t\t\tif (\n\t\t\t\t\t\tresult.finalPrice < currentPrice ||\n\t\t\t\t\t\t(result.finalPrice === currentPrice && result.freeGifts > currentFreeGifts)\n\t\t\t\t\t) {\n\t\t\t\t\t\tsuccessfulCodes.push(discount.code);\n\t\t\t\t\t\tcurrentDiscount = result.finalDiscount;\n\t\t\t\t\t\tcurrentPrice = result.finalPrice;\n\t\t\t\t\t\tcurrentFreeGifts = result.freeGifts;\n\t\t\t\t\t\treturn Promise.resolve();\n\t\t\t\t\t}\n\t\t\t\t\treturn this._removeCode(discount.code);\n\t\t\t\t});\n\t\t\t}),\n\t\t).then(() =>\n\t\t\tbus.$emit('stackable-complete', {\n\t\t\t\tcodes: successfulCodes,\n\t\t\t\tfinalPrice: currentPrice,\n\t\t\t\tfinalDiscount: currentDiscount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tmakeApprovalRequest() {\n\t\treturn super.makeApprovalRequest().then(() => this._deleteCartCookie());\n\t}\n\n\tgetPreTaxShippingTotal() {\n\t\treturn this._getUpdatedCart().then(responseHTML => {\n\t\t\tconst total = this.parseTotal(responseHTML);\n\t\t\tconst shipping = extractData(this.SHIPPING_SELECTOR, responseHTML);\n\t\t\tconst calculatedShipping = shipping.toLowerCase().includes('free') ? 0 : shipping;\n\t\t\treturn total - toFloat(calculatedShipping);\n\t\t});\n\t}\n\n\t_getUpdatedCart() {\n\t\treturn fetch(window.location.href, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n\n\t_deleteCartCookie() {\n\t\treturn fetch(`${this.BASE_URL}/MiniShopCartDisplayView?${this.MINI_SHOP_REQUEST_PARAMS.toString()}`, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\tbody: this.MINI_SHOP_REQUEST_BODY_PARAMS,\n\t\t\theaders: {\n\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t'content-type': 'application/x-www-form-urlencoded',\n\t\t\t},\n\t\t});\n\t}\n\n\t_parseItemsCount(data) {\n\t\tif (data) {\n\t\t\t// need to calculate count of items in a such way, because there is code,\n\t\t\t// which gives two the same gifts and they are placed in one row\n\t\t\treturn [...data.match(this.ITEM_QUANTITY_REGEXP)].reduce(\n\t\t\t\t(count, el, i) => count + toInt(extractElement(`#${el}${i + 1}`, data).value),\n\t\t\t\t0,\n\t\t\t);\n\t\t}\n\t\treturn toInt(extractElement(this.BASKET_COUNT_SELECTOR).textContent);\n\t}\n};\n\nexport default {\n\tname: 'Canon',\n\tdomain: 'canon.com',\n\tstackable: true,\n\tDriver,\n\tmaxCoupons: 1, // site works very slow\n\tisOnCartUrl(href) {\n\t\tconst hrefToLowerCase = href.toLowerCase();\n\t\treturn (\n\t\t\t(hrefToLowerCase.startsWith(`${BASE_URL}/orderitemdisplay`) ||\n\t\t\t\threfToLowerCase.startsWith(`${BASE_URL}/ajaxcheckoutdisplayview`) ||\n\t\t\t\threfToLowerCase.startsWith(`${BASE_URL}/ajaxorderitemdisplayview`)) &&\n\t\t\tdocument.querySelector('#promoCode') &&\n\t\t\tdocument.querySelector('#order_total')\n\t\t);\n\t},\n\tisCartEmpty() {\n\t\treturn Boolean(document.querySelector('#WC_EmptyShopCartDisplayf_div_1'));\n\t},\n};\n","import Hp from './_base';\nimport { DOM } from '../../../utils';\nimport { elemToFloat } from '../../../utils/format';\n\nconst { extractFormValues, extractElement } = DOM;\n\n/* Behavior description:\n+ Existing code: yes\n+ Remove code: yes\n+ Stackable: yes\n+ Free gift support: no\n+ Free shipping: no\n+ isValid implemented: yes\n+ Manually apply code: no\n+ Pages, where extension works: Cart, Checkout(without Shipping Step)\n+ Is driver SPA: yes\n+ Gather codes on site pages: yes\n */\n\nconst BASE_URL = 'https://www.davidsbridal.com';\nconst isCheckoutPage = window.location.href.includes('/OrderCheckoutView');\n\nconst Driver = class Driver extends Hp {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.BASE_URL = `${BASE_URL}/webapp/wcs/stores/servlet`;\n\t\tthis.TOTAL_SELECTOR = `#WC_SingleShipmentOrderTotalsSummary_td_${isCheckoutPage ? '10' : '13'}`;\n\t\tthis.TAX_SELECTOR = '#WC_SingleShipmentOrderTotalsSummary_td_6';\n\t\tthis.SHIPPING_SELECTOR = '#WC_SingleShipmentOrderTotalsSummary_td_8';\n\t\tthis.APPLY_FORM = null;\n\t\tthis.APPLIED_CODES_SELECTOR = '.promotion_used div';\n\t\tthis.CODE_INPUT_SELECTOR = '[name=\"promoCode\"]';\n\t\tthis.EMPTY_CART_SELECTOR = '[id^=WC_EmptyShopCartDisplay]';\n\t\tthis.SHIPPING_FORM_SELECTOR = '#shippingAddressForm';\n\t\tthis.APPLY_FORM_SELECTOR = '#PromotionCodeForm';\n\t\tthis.PROPOSE_CODES_SELECTOR = '.offerBody b';\n\t\tthis.PAGE_CODES_SELECTOR = '[id*=monetate_selectorBanner] img';\n\t\tthis.PAGE_CODE_REGEX = /code (\\w+)/i;\n\t\tthis.MERCHANT_CODE_REGEX = /Use code: (\\w+)/;\n\t\tthis.IS_STACKABLE = true;\n\t}\n\n\tcheckCondition() {\n\t\tconst { href } = window.location;\n\t\tconst isOnRightURL =\n\t\t\thref.includes('/AjaxOrderItemDisplayView') || href.startsWith(`${BASE_URL}/OrderCheckoutView`);\n\t\tconst emptyCartEl = document.querySelector(this.EMPTY_CART_SELECTOR);\n\t\tconst isOnShipping = document.querySelector(this.SHIPPING_FORM_SELECTOR);\n\t\treturn isOnRightURL && !emptyCartEl && !isOnShipping;\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.APPLY_FORM = extractFormValues(this.APPLY_FORM_SELECTOR);\n\t}\n\n\tgetMerchantCodes() {\n\t\t// can get merchant codes from page and request's response\n\t\tconst pageCodes = [...document.querySelectorAll(this.PAGE_CODES_SELECTOR)]\n\t\t\t.map(el => el.getAttribute('alt'))\n\t\t\t.filter(Boolean)\n\t\t\t.map(el => el.match(this.PAGE_CODE_REGEX))\n\t\t\t.filter(Boolean)\n\t\t\t.map(el => el[1]);\n\t\tconst pageCodesUnique = [...new Set(pageCodes)];\n\n\t\treturn this._getProposedCoupons().then(responseHTML => {\n\t\t\tif (!responseHTML) {\n\t\t\t\treturn pageCodesUnique;\n\t\t\t}\n\t\t\tconst proposedCodes = [...extractElement(this.PROPOSE_CODES_SELECTOR, responseHTML, true)]\n\t\t\t\t.map(el => el.textContent.trim().match(this.MERCHANT_CODE_REGEX))\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.map(el => el[1]);\n\t\t\treturn [...pageCodesUnique, ...proposedCodes];\n\t\t});\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = [...document.querySelectorAll(this.APPLIED_CODES_SELECTOR)].map(\n\t\t\telement => element.textContent.split(/\\s/)[0],\n\t\t);\n\t\treturn {\n\t\t\tcodes,\n\t\t\tcodeCount: codes.length,\n\t\t};\n\t}\n\n\tgetPreTaxShippingTotal() {\n\t\treturn this.getUpdatedCart().then(response => {\n\t\t\tconst tax = elemToFloat(extractElement(this.TAX_SELECTOR, response)) || 0;\n\t\t\tconst shipping = elemToFloat(extractElement(this.SHIPPING_SELECTOR, response)) || 0;\n\t\t\treturn this.parseTotal(response) - tax - shipping;\n\t\t});\n\t}\n\n\t_getProposedCoupons() {\n\t\treturn fetch(`${BASE_URL}/Content_BuyOnline_offers`, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n};\n\nexport default {\n\tname: 'David`s Bridal',\n\tdomain: 'davidsbridal.com',\n\tDriver,\n\tstackable: true,\n\tisSinglePageApp: true,\n};\n","import Hp from './_base';\nimport { DOM } from '../../../utils';\n\nconst { extractFormValues } = DOM;\n\n/** Behavior description:\n * - can get existing codes\n * - can remove codes\n * - can apply multiple codes (stackable)\n * ======== Special case ========\n * extension runs about 35 sec with one valid code, so I decreased the number of maxCoupons to 5\n * */\n\nconst BASE_URL = 'https://estore.canon.ca';\n\nconst Driver = class Driver extends Hp {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.BASE_URL = `${BASE_URL}/webapp/wcs/stores/servlet`;\n\t\tthis.TOTAL_SELECTOR = '.table_orderTotal .row:last-of-type .total_figures';\n\t\tthis.FORM_SELECTOR = '#PromotionCodeForm';\n\t\tthis.APPLIED_CODES_REG = /\"PromotionCodeForm\",\"([^\"]+)\"/;\n\t\tthis.IS_STACKABLE = true;\n\t\tthis.APPLIED_CODE_SELECTOR = '[id^=promotion_]';\n\t\tthis.APPLY_FORM = null;\n\t\tthis.SPINNER_SELECTOR = '#progress_bar_dialog';\n\t\tthis.CODE_INPUT_SELECTOR = '#promoCode';\n\t}\n\n\tcheckCondition() {\n\t\tconst spinner = document.querySelector(this.SPINNER_SELECTOR);\n\t\tconst { href } = window.location;\n\t\tconst isSpinner = spinner && spinner.offsetParent;\n\t\tconst isPromoInput = document.querySelector(this.CODE_INPUT_SELECTOR);\n\t\tconst currentState =\n\t\t\t!isSpinner &&\n\t\t\tisPromoInput &&\n\t\t\t(href.includes('AjaxOrderItemDisplayView') ||\n\t\t\t\thref.includes('OrderShippingBillingView') ||\n\t\t\t\thref.includes('AjaxCheckoutDisplayView'));\n\t\treturn currentState;\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.APPLY_FORM = extractFormValues(this.FORM_SELECTOR);\n\t\treturn Promise.resolve();\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = [...document.querySelectorAll(this.APPLIED_CODE_SELECTOR)].map(\n\t\t\telement => element.getAttribute('onClick').match(this.APPLIED_CODES_REG)[1],\n\t\t);\n\t\treturn {\n\t\t\tcodes,\n\t\t\tcodeCount: codes.length,\n\t\t};\n\t}\n};\n\nexport default {\n\tname: 'Canon Canada',\n\tdomain: 'estore.canon.ca',\n\tDriver,\n\tstackable: true,\n\tisSinglePageApp: true,\n\tmaxCoupons: 5,\n\tisOnCartUrl: () => false,\n};\n","import Promise from 'bluebird';\nimport Hp from './_base';\nimport bus from '../../bus';\nimport { handleDriverError } from '../../lib';\nimport { format, DOM, log } from '../../../utils';\n\nconst { toFloat, elemToFloat } = format;\nconst { extractElement, extractElementFromHTML } = DOM;\n\n/*\nBehavior description:\n+ Existing code: yes\n+ Remove code: yes\n+ Stackable: no\n+ Free gift support: no\n+ Free shipping: no\n+ isValid implemented: yes\n+ Codes can be replaced by another code: no\n+ Manually apply code: no\n+ Pages, where extension works: Cart\n+ Is driver SPA: yes\n+ maxCoupons: 12 (testing time)\n+ Gather codes on site pages: no\n=====Special case=====\n+ We can't support checkout because of incorrect response from merchant, strange behavior on it\n*/\n\nconst BASE_URL = 'https://store.hp.com';\n\nconst Driver = class Driver extends Hp {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.BASE_URL = `${BASE_URL}/us/en`;\n\t\tthis.TOTAL_ELEMENT_CONFIG = { selector: '#cartTotal' };\n\t\tthis.APPLY_FORM_SELECTOR = '#searchHP';\n\t\tthis.APPLIED_CODES_SELECTOR = '.removeCpn';\n\t\tthis.ORDER_ID_SELECTOR = '#orderId';\n\t\tthis.LANG_ID_SELECTOR = '[name=\"langId\"]';\n\t\tthis.STORE_ID_SELECTOR = '[name=\"storeId\"]';\n\t\tthis.CATALOG_ID_SELECTOR = '[name=\"catalogId\"]';\n\n\t\tthis.LOADING_ELEMENT_SELECTOR = '#loadingOverlay';\n\t\tthis.INPUT_CODE_SELECTOR_ON_CART = '#cpnCode';\n\n\t\tthis.IS_LOYALTY_SELECTOR = '#isLoyaltyProd';\n\t\tthis.SHIPPING_SELECTOR = '[name=\"shipping-option\"]:checked';\n\t\tthis.SHIPPING_REGEX = /\\((.*)\\)/;\n\t}\n\n\tcheckCondition() {\n\t\tconst onCartEl = document.querySelector(this.INPUT_CODE_SELECTOR_ON_CART);\n\t\tconst onCartCond = onCartEl ? onCartEl.offsetParent : false;\n\t\tconst loadingEl = document.querySelector(this.LOADING_ELEMENT_SELECTOR);\n\t\tconst loadingCond = loadingEl ? loadingEl.classList.contains('hide') : false;\n\t\treturn !!onCartCond && loadingCond;\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.BODY_DATA = {};\n\t\tthis.BODY_DATA.orderId = document.querySelector(this.ORDER_ID_SELECTOR).getAttribute('value');\n\t\tthis.BODY_DATA.langId = document.querySelector(this.LANG_ID_SELECTOR).getAttribute('value');\n\t\tthis.BODY_DATA.storeId = document.querySelector(this.STORE_ID_SELECTOR).getAttribute('value');\n\t\tthis.BODY_DATA.catalogId = document.querySelector(this.CATALOG_ID_SELECTOR).getAttribute('value');\n\n\t\tthis.APPLY_FORM = { ...this.BODY_DATA };\n\t\tthis.REMOVE_FORM = { ...this.BODY_DATA };\n\t\tthis.APPROVAL_REQUEST_PARAMS = { ...this.BODY_DATA };\n\t\tthis.APPROVAL_REQUEST_PARAMS = new URLSearchParams(this.APPROVAL_REQUEST_PARAMS);\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('calculationUsage', '-1,-2,-5,-6,-7');\n\n\t\tconst isLoyaltyEl = document.querySelector(this.IS_LOYALTY_SELECTOR).value;\n\t\tthis.APPLY_FORM.isLoyaltyEligible = isLoyaltyEl || 'false';\n\t\tthis.APPLY_FORM.finalView = 'AjaxOrderItemDisplayView';\n\t\tthis.APPLY_FORM.loyaltyAmt = '0';\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = [...document.querySelectorAll(this.APPLIED_CODES_SELECTOR)].map(element => element.dataset.cpn);\n\t\treturn {\n\t\t\tcodes,\n\t\t\tcodeCount: codes.length,\n\t\t};\n\t}\n\n\tbeforeCheckCodes() {\n\t\t// Sometimes driver gets bad original price from page\n\t\treturn this.getUpdatedCart().then(html => this.parseTotal(html));\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis._applyCode(code).then(responseObject => {\n\t\t\t\tconst result = {\n\t\t\t\t\tcode,\n\t\t\t\t\tfinalPrice: originalPrice,\n\t\t\t\t\tfinalDiscount: 0,\n\t\t\t\t\tisValid: true,\n\t\t\t\t};\n\t\t\t\tif (!responseObject || responseObject.errorCode) {\n\t\t\t\t\tresult.isValid = false;\n\t\t\t\t\treturn bus.$emit('code-checked', result);\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedCart().then(html => {\n\t\t\t\t\tresult.finalPrice = this.parseTotal(html);\n\t\t\t\t\tresult.finalDiscount = originalPrice - result.finalPrice;\n\t\t\t\t\treturn this._removeCode(code).then(() => bus.$emit('code-checked', result));\n\t\t\t\t});\n\t\t\t}),\n\t\t);\n\t}\n\n\tapplyCodes(codes) {\n\t\treturn this._applyCode(codes[0]);\n\t}\n\n\tgetPreTaxShippingTotal() {\n\t\treturn this.getUpdatedCart().then(responseHTML => {\n\t\t\tconst shippingEl = extractElement(this.SHIPPING_SELECTOR, responseHTML);\n\t\t\tconst shipping = shippingEl\n\t\t\t\t? toFloat(shippingEl.nextElementSibling.textContent.match(this.SHIPPING_REGEX)[1]) || 0\n\t\t\t\t: 0;\n\t\t\treturn this.parseTotal(responseHTML) - shipping;\n\t\t});\n\t}\n\n\t_manageCode(url, body) {\n\t\treturn (\n\t\t\tfetch(url, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tcredentials: 'include',\n\t\t\t\theaders: {\n\t\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t\t'content-type': 'application/x-www-form-urlencoded; charset=UTF-8',\n\t\t\t\t},\n\t\t\t\tbody,\n\t\t\t})\n\t\t\t\t// This request is required, otherwise coupon code won't be applied or removed\n\t\t\t\t.then(response => response.text())\n\t\t\t\t.then(responseText => {\n\t\t\t\t\tconst responseObject = this._parseResponse(responseText);\n\t\t\t\t\t// if there is an error, there is no need to make approval request\n\t\t\t\t\tif (responseObject && !responseObject.errorCode) {\n\t\t\t\t\t\treturn this.makeApprovalRequest().then(() => responseObject);\n\t\t\t\t\t}\n\t\t\t\t\treturn responseObject;\n\t\t\t\t})\n\t\t);\n\t}\n\n\t_parseResponse(responseText) {\n\t\ttry {\n\t\t\treturn JSON.parse(\n\t\t\t\tresponseText\n\t\t\t\t\t.replace('/*', '')\n\t\t\t\t\t.replace('*/', '')\n\t\t\t\t\t.trim(),\n\t\t\t);\n\t\t} catch (e) {\n\t\t\tif (responseText.match(/Access Denied/i)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\thandleDriverError(new Error(`Invalid json string.`), { responseText });\n\t\t\treturn null;\n\t\t}\n\t}\n\n\t_applyCode(code) {\n\t\tthis.APPLY_FORM = new URLSearchParams(this.APPLY_FORM);\n\t\tthis.APPLY_FORM.set('promoCode', code);\n\t\tthis.APPLY_FORM.set('taskType', 'A');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('tasktype[]', 'A');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('promoCode', code);\n\t\treturn this._manageCode(this._getUrl(), this.APPLY_FORM);\n\t}\n\n\t_removeCode(code) {\n\t\tthis.REMOVE_FORM = new URLSearchParams(this.REMOVE_FORM);\n\t\tthis.REMOVE_FORM.set('promoCode', code);\n\t\tthis.REMOVE_FORM.set('taskType', 'R');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('tasktype[]', 'R');\n\t\tthis.APPROVAL_REQUEST_PARAMS.set('promoCode', code);\n\t\treturn this._manageCode(this._getUrl(false), this.REMOVE_FORM);\n\t}\n\n\tparseTotal(html) {\n\t\tlet totalElement = null;\n\t\tif (html) {\n\t\t\ttotalElement = extractElementFromHTML(html, this.TOTAL_ELEMENT_CONFIG.selector);\n\t\t} else {\n\t\t\ttotalElement = document.querySelector(this.TOTAL_ELEMENT_CONFIG.selector);\n\t\t}\n\t\treturn elemToFloat(totalElement);\n\t}\n};\n\nexport default {\n\tname: 'HP',\n\tdomain: 'hp.com',\n\tDriver,\n\tmaxCoupons: 12,\n\tisSinglePageApp: true,\n};\n","import canon from './canon.com';\nimport davidsbridal from './davidsbridal.com';\nimport estoreCanon from './estore.canon.ca';\nimport hp from './hp.com';\nimport petco from './petco.com';\n\nexport default [canon, davidsbridal, estoreCanon, hp, petco];\n","import Promise from 'bluebird';\nimport Hp from './_base';\nimport bus from '../../bus';\nimport { DOM, sendXhr, format, log } from '../../../utils';\n\nconst { extractFormValues, extractElement } = DOM;\nconst { elemToFloat } = format;\n\n/* Behavior description:\n\t+ Existing code: yes\n\t+ Remove code: yes\n\t+ Stackable: no\n\t+ Free gift support: no\n\t+ Free shipping: no\n\t+ isValid implemented: yes\n\t+ Codes can be replaced by another code: yes\n\t+ Manually apply code: no\n\t+ Is driver SPA: yes\n\t+ Gather codes on site pages: yes(cart page)\n=======================\nSpecial case:\n\t- Shipping request required on the checkout page, for right total\n\t- maxCoupons: 2, due to blocking\n\t- don't allow code testing when user has applied code\n*/\n\nconst { href } = window.location;\nconst BASE_URL = 'https://www.petco.com';\nconst IS_CHECKOUT = href.includes('/SingleShipmentOrderSummaryView');\n\nconst Driver = class Driver extends Hp {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.BASE_URL = `${BASE_URL}/shop`;\n\t\tthis.TOTAL_SELECTOR =\n\t\t\t'#WC_SingetUpdatedCartgleShipmentOrderTotalsSummary_td_13, #WC_SingleShipmentOrderTotalsSummary_td_10, #WC_SingleShipmentOrderTotalsSummary_td_13';\n\t\tthis.APPLY_FORM = extractFormValues('#PromotionCodeForm');\n\t\tthis.APPLIED_CODES_SELECTOR = '.applied-promo a, #petcoPromotionDisplayArea .form-field-name';\n\n\t\tthis.PROMO_SELECTOR = '#payment-information-promo-code, #promo-display';\n\t\tthis.EMPTY_CRT_SELECTOR = '.empty-cart';\n\n\t\tthis.NEWRELIC_ID_REGEX = /xpid:\"([^\"]*)\"/;\n\t\tthis.NEWRELIC_ID = null;\n\n\t\tthis.CODE_INPUT_SELECTOR = '#enter-promo-code';\n\t\tthis.APPLY_BUTTON_SELECTOR = '#WC_PromotionCodeDisplay_links_1';\n\t\tthis.updateBodyData = new URLSearchParams({\n\t\t\tbeginIndex: 0,\n\t\t\tfromPage: 'paymentMethodPage',\n\t\t\tobjectId: '',\n\t\t\trequesttype: 'ajax',\n\t\t});\n\t\tthis.shippingUpdateData = null;\n\n\t\tthis.INDEX_SELECTOR = '.order-summary li span:first-child';\n\t\tthis.VALUE_SELECTOR = '.order-summary li span:last-child';\n\t\tthis.ORDER_ID_SELECTOR = '#orderIdForPurcList';\n\t\tthis.TOTAL_PRICE_REGEXP = /orderTotal:\\s([0-9.]+)/;\n\t\tthis.MERCHANT_CODE_SELECTOR = '#promo-strip-carousel strong';\n\t}\n\n\tcheckCondition() {\n\t\tconst promoInput = document.querySelector(this.PROMO_SELECTOR);\n\t\tconst isCartEmpty = document.querySelector(this.EMPTY_CRT_SELECTOR);\n\t\tconst isOnRightUrl =\n\t\t\t(href.includes('/SingleShipmentOrderSummaryView') &&\n\t\t\t\t!document.querySelector('#payment-section.disabled-section')) ||\n\t\t\thref.includes('/OrderCheckoutView') ||\n\t\t\thref.includes('/OrderItemDisplay') ||\n\t\t\thref.includes('/OrderCalculate') ||\n\t\t\thref.includes('/AjaxCheckoutDisplayView');\n\t\t// don't allow code testing when user has applied code\n\t\tconst isCodeApplied = document.querySelector(this.APPLIED_CODES_SELECTOR);\n\t\treturn isOnRightUrl && promoInput && !isCodeApplied && !isCartEmpty;\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.APPROVAL_REQUEST_PARAMS = new URLSearchParams({\n\t\t\tstoreId: 10151,\n\t\t\tcatalogId: 10051,\n\t\t\tlangId: -1,\n\t\t\torderId: '.',\n\t\t\tcalculationUsage: '-1,-3,-4,-6,-7',\n\t\t\trequesttype: 'ajax',\n\t\t});\n\t\t[, this.NEWRELIC_ID] = [...document.querySelectorAll('script')]\n\t\t\t.find(element => element.text.match(this.NEWRELIC_ID_REGEX))\n\t\t\t.text.match(this.NEWRELIC_ID_REGEX);\n\t\tif (IS_CHECKOUT) {\n\t\t\tthis.shippingUpdateData = new URLSearchParams({\n\t\t\t\tstoreId: 10151,\n\t\t\t\tcatalogId: 10051,\n\t\t\t\tlangId: -1,\n\t\t\t\torderId: document.querySelector(this.ORDER_ID_SELECTOR).value,\n\t\t\t\trequesttype: 'ajax',\n\t\t\t});\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\tgetMerchantCodes() {\n\t\treturn this.getUpdatedCart().then(resHtml => {\n\t\t\treturn [\n\t\t\t\t...new Set(\n\t\t\t\t\t[...extractElement(this.MERCHANT_CODE_SELECTOR, resHtml, true)]\n\t\t\t\t\t\t.map(item => item.textContent)\n\t\t\t\t\t\t.filter(Boolean),\n\t\t\t\t),\n\t\t\t];\n\t\t});\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = [...document.querySelectorAll(this.APPLIED_CODES_SELECTOR)].map(el => el.textContent);\n\n\t\treturn {\n\t\t\tcodes,\n\t\t\tcodeCount: codes.length,\n\t\t};\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis._applyCode(code).then(responseObject => {\n\t\t\t\t// no need to get updated cart or remove code if apply returned error\n\t\t\t\tif (responseObject.errorCode) {\n\t\t\t\t\treturn bus.$emit('code-checked', {\n\t\t\t\t\t\tcode,\n\t\t\t\t\t\tfinalPrice: originalPrice,\n\t\t\t\t\t\tfinalDiscount: 0,\n\t\t\t\t\t\tisValid: false,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\treturn this.getUpdatedData().then(html => {\n\t\t\t\t\tconst finalPrice = this.parseTotal(html);\n\t\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\t\t\t\t\tconst result = { code, finalPrice, finalDiscount };\n\t\t\t\t\tif (finalPrice < originalPrice) {\n\t\t\t\t\t\tresult.isValid = true;\n\t\t\t\t\t}\n\t\t\t\t\treturn this._removeCode(code).then(() => bus.$emit('code-checked', result));\n\t\t\t\t});\n\t\t\t}),\n\t\t);\n\t}\n\n\t_parseResponse(responseText) {\n\t\tif (responseText.includes('permission')) {\n\t\t\treturn { errorCode: 'error' };\n\t\t}\n\t\treturn JSON.parse(\n\t\t\tresponseText\n\t\t\t\t.replace('/*', '')\n\t\t\t\t.replace('*/', '')\n\t\t\t\t.trim(),\n\t\t);\n\t}\n\n\t_manageCode(code, url) {\n\t\tconst body = this._getManageCodeParams(code);\n\t\treturn (\n\t\t\tsendXhr(url, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tcredentials: 'include',\n\t\t\t\theaders: {\n\t\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t\t'x-newrelic-id': this.NEWRELIC_ID,\n\t\t\t\t},\n\t\t\t\tbody,\n\t\t\t})\n\t\t\t\t// This request is required, otherwise coupon code won't be applied or removed\n\t\t\t\t.then(response => response.text())\n\t\t\t\t.then(responseText => {\n\t\t\t\t\tconst responseObject = this._parseResponse(responseText);\n\t\t\t\t\t// if there will be error, there is no need to make approval request\n\t\t\t\t\tif (!responseObject.errorCode) {\n\t\t\t\t\t\tthis.makeApprovalRequest().then(() => responseObject);\n\t\t\t\t\t}\n\t\t\t\t\treturn responseObject;\n\t\t\t\t})\n\t\t);\n\t}\n\n\tmakeApprovalRequest() {\n\t\treturn sendXhr(`${this.BASE_URL}/AjaxOrderChangeServiceItemUpdate`, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\theaders: {\n\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t'x-newrelic-id': this.NEWRELIC_ID,\n\t\t\t},\n\t\t\tbody: this.APPROVAL_REQUEST_PARAMS,\n\t\t});\n\t}\n\n\tgetUpdatedData() {\n\t\tif (IS_CHECKOUT) {\n\t\t\tthis.regExpTotal = true;\n\t\t\treturn sendXhr(`${this.BASE_URL}/orderTotalAsJSON`, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tcredentials: 'include',\n\t\t\t\theaders: {\n\t\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t\t'x-newrelic-id': this.NEWRELIC_ID,\n\t\t\t\t},\n\t\t\t\tbody: new URLSearchParams({ storeId: 10151, catalogId: 10051, langId: -1 }),\n\t\t\t}).then(response => response.text());\n\t\t}\n\t\treturn this.getUpdatedCart();\n\t}\n\n\tgetUpdatedCart() {\n\t\treturn sendXhr(window.location.href, {\n\t\t\tmethod: 'GET',\n\t\t\theaders: {\n\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t'x-newrelic-id': this.NEWRELIC_ID,\n\t\t\t},\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n\n\tgetPreTaxShippingTotal() {\n\t\treturn this.getUpdatedCart().then(responseHTML => {\n\t\t\tconst getValue = regEx => {\n\t\t\t\tconst index = [...extractElement(this.INDEX_SELECTOR, responseHTML, true)]\n\t\t\t\t\t.map(el => regEx.test(el.textContent))\n\t\t\t\t\t.indexOf(true);\n\t\t\t\treturn index !== -1\n\t\t\t\t\t? elemToFloat([...extractElement(this.VALUE_SELECTOR, responseHTML, true)][index])\n\t\t\t\t\t: 0;\n\t\t\t};\n\t\t\tconst totalValue = this.parseTotal(responseHTML);\n\t\t\tconst taxValue = getValue(/taxes/i);\n\t\t\tconst shippingValue = getValue(/shipping/i);\n\t\t\tconst donation = getValue(/donation/i);\n\n\t\t\treturn totalValue - taxValue - shippingValue - donation;\n\t\t});\n\t}\n\n\tparseTotal(data) {\n\t\tif (this.regExpTotal) {\n\t\t\tthis.regExpTotal = false;\n\n\t\t\treturn data.match(this.TOTAL_PRICE_REGEXP)[1];\n\t\t}\n\t\treturn elemToFloat(extractElement(this.TOTAL_SELECTOR, data));\n\t}\n\n\tupdatedShipping() {\n\t\treturn sendXhr(`${this.BASE_URL}/PetcoAjaxShippingMethodUpdateCmd`, {\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'x-requested-with': 'XMLHttpRequest',\n\t\t\t\t'Content-Type': 'application/x-www-form-urlencoded',\n\t\t\t\t'x-newrelic-id': this.NEWRELIC_ID,\n\t\t\t},\n\t\t\tcredentials: 'include',\n\t\t\tbody: this.shippingUpdateData,\n\t\t});\n\t}\n};\n\nexport default {\n\tname: 'Petco',\n\tdomain: 'petco.com',\n\tDriver,\n\tmaxCoupons: 2, // due to blocking\n\tisSinglePageApp: true,\n};\n"],"sourceRoot":""}