{"version":3,"sources":["webpack:///./src/inject/drivers/base.js","webpack:///./src/inject/drivers/chicos/_base.js","webpack:///./src/inject/drivers/chicos/_common.js","webpack:///./src/inject/drivers/chicos/index.js","webpack:///./src/inject/drivers/chicos/soma.com.js","webpack:///./src/inject/drivers/chicos/whitehouseblackmarket.com.js"],"names":["toFloat","format","BaseDriver","watchForRestoreUserData","time","pauseInterval","interval","setInterval","currentState","checkRestoreDataCondition","clearInterval","bus","$emit","e","handleDriverError","source","storeUserData","domain","userData","getUserData","Promise","resolve","userDataKey","getUserDataStorageKey","storageRecord","storedTime","Date","now","backgroundMessaging","setDriverStorage","log","restoreUserData","maxStorageLifetime","driverStorage","getDriverStorage","deleteDriverStorage","setUserData","getStartPrice","startPrice","Number","MAX_SAFE_INTEGER","totalElementConfig","TOTAL_ELEMENT_CONFIG","selector","attribute","regex","totalElement","Array","isArray","forEach","elemSelector","document","querySelector","Error","value","getAttribute","textContent","pattern","group","match","beforeTestCodes","beforeCheckCodes","beforeApplyCodes","checkCodes","applyCodes","stackCodes","removeCodes","getMerchantCodes","getExistingCodes","codes","codeCount","getPreTaxShippingTotal","watchForCartUrl","previousState","checkCondition","completeExperience","completeExperiencePromisified","args","_promisify","beforeTestCodesPromisified","getStartPricePromisified","getMerchantCodesPromisified","getExistingCodesPromisified","removeCodesPromisified","beforeApplyCodesPromisified","applyCodesPromisified","beforeCheckCodesPromisified","checkCodesPromisified","stackCodesPromisified","method","then","apply","extractFormValues","DOM","Driver","constructor","APPLY_BUTTON_SELECTOR","CODES_SELECTOR","CODE_INPUT_SELECTOR","COUPON_FORM_SELECTOR","TOTAL_SELECTOR","REMOVE_URL","SHIPPING_SECTION_OPENED_SELECTOR","SHIPPING_OPTION_OPENED_SELECTOR","CART_EMPTY_SELECTOR","href","window","location","isCart","includes","isCheckout","isCartEmpty","isShippingStep","isShippingOption","offsetParent","COUPON_APPLY_PARAM_NAME","_isOnCartPage","requestData","removeQueryParams","URLSearchParams","task","reprice","_DARGS","_dynSessConf","params","get","Set","querySelectorAll","map","element","id","split","replace","filter","code","size","lastResponse","each","removeCode","responseJSON","parseTotal","originalPrice","workingDiscounts","applyCode","finalPrice","finalDiscount","isValid","_isValidCode","result","push","discount","discounts","validationInfo","sort","a","b","currentPrice","currentDiscount","successfulCodes","set","fetch","action","credentials","headers","Accept","body","response","json","toString","dataJSON","total","subtotal","order","orderDetails","orderTotal","udsItemsTotal","innerText","formErrors","coupon","length","isOnCartPage","pathname","isOnCartUrl","soma","whitehouseblackmarket","DriverTemplate","CHARGES_REGEX","CHARGES_SELECTOR","cartJSON","cartStr","_getUpdatedCart","elemToFloat","extractElement","taxes","el","parentElement","Boolean","reduce","charges","charge","text","name","stackable","isSinglePageApp","getCookie","browserUtils","sessionTimer","initialize","actionInterval","timeout","REMOVE_FORM_SELECTOR","REMOVE_PARAM_NAME","CART_ITEMS_SELECTOR","CART_ITEMS_REGEXP","MERCHANT_CODES_SELECTOR","MERCHANT_CODES_REGEXP","isItemsInCart","isUSAChosen","isTotal","isDollar","startsWith","removeRequestData","responseJson","items","item","isDonation","responseText","USASalesTax","donation","priceAfterDiscount","finalItemPrice","_manageCode","sendXhr","data","maxCoupons"],"mappings":"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","file":"drivers__chicos.bundle.js","sourcesContent":["import bus from '../bus';\nimport { log, format } from '../../utils';\nimport { backgroundMessaging, handleDriverError } from '../lib';\n\nconst { toFloat } = format;\n\nexport default class BaseDriver {\n\t/**\n\t * @function watchForRestoreUserData - set up a listener to check user data restorement\n\t * @emits bus#RestoreUserData - the event that indicates to the app\tthat user data could be restored\n\t */\n\twatchForRestoreUserData(time = 500) {\n\t\tlet pauseInterval = false;\n\t\tconst interval = setInterval(async () => {\n\t\t\tif (!pauseInterval) {\n\t\t\t\ttry {\n\t\t\t\t\t// Pause interval to avoid triggering multiple times `checkCondition`\n\t\t\t\t\t// before the response will be received\n\t\t\t\t\tpauseInterval = true;\n\t\t\t\t\tconst currentState = await this.checkRestoreDataCondition();\n\t\t\t\t\tpauseInterval = false;\n\t\t\t\t\tif (currentState) {\n\t\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\t\tbus.$emit('restore-user-data');\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\thandleDriverError(e, { source: 'checkRestoreDataCondition' });\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t}\n\t\t\t}\n\t\t}, time);\n\n\t\treturn interval;\n\t}\n\n\tcheckRestoreDataCondition() {\n\t\treturn false;\n\t}\n\n\t/**\n\t * @function storeUserData\n\t * @param {String} domain - domain to set the driver storage\n\t * @returns {Promise}\n\t */\n\tasync storeUserData(domain) {\n\t\tconst userData = await this.getUserData();\n\n\t\tif (userData === null) {\n\t\t\t// Nothing to store\n\t\t\treturn Promise.resolve();\n\t\t}\n\t\tconst userDataKey = this.getUserDataStorageKey(domain);\n\t\tconst storageRecord = {\n\t\t\tuserData,\n\t\t\tstoredTime: Date.now(),\n\t\t};\n\t\tbackgroundMessaging.setDriverStorage(userDataKey, storageRecord);\n\t\tlog('Stored user data: %O', storageRecord);\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function restoreUserData\n\t * @param {String} domain - domain to access the driver storage\n\t * @param {Number} [maxStorageLifetime] - optional, the lifetime of the stored data (default 10 mins)\n\t * @returns {Promise}\n\t */\n\tasync restoreUserData(domain, maxStorageLifetime = 600000) {\n\t\tconst userDataKey = this.getUserDataStorageKey(domain);\n\t\tconst driverStorage = await backgroundMessaging.getDriverStorage(userDataKey);\n\n\t\tif (driverStorage) {\n\t\t\tconst { storedTime, userData } = driverStorage;\n\t\t\t// Clear stored user data\n\t\t\tbackgroundMessaging.deleteDriverStorage(userDataKey);\n\n\t\t\tif (Date.now() - storedTime <= maxStorageLifetime) {\n\t\t\t\tlog('Restore user data: %O', userData);\n\t\t\t\treturn this.setUserData(userData);\n\t\t\t}\n\t\t\tlog('User data is outdated, skip restoring');\n\t\t}\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function getUserData - get user data which should be stored\n\t * @returns {Object} - object with required user data which should be restored\n\t */\n\tgetUserData() {\n\t\treturn null;\n\t}\n\n\t/**\n\t * @function setUserData - restore user data on page\n\t * @param {Object} userData - data which was saved and should be restored\n\t * @returns {Promise}\n\t */\n\tsetUserData() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function getUserDataStorageKey - unique key for storing user data per merchant\n\t * @returns {String}\n\t */\n\tgetUserDataStorageKey(domain) {\n\t\t// Append `_userData` to avoid possible conflicts with created storage from driver\n\t\treturn `${domain}_userData`;\n\t}\n\n\t/**\n\t * Parses start price from page\n\t *\n\t * @function getStartPrice\n\t * @returns {Promise<Number>|Number} - the total from the page\n\t */\n\tgetStartPrice() {\n\t\tlet startPrice = Number.MAX_SAFE_INTEGER;\n\t\tconst totalElementConfig = this.TOTAL_ELEMENT_CONFIG;\n\t\tif (totalElementConfig) {\n\t\t\tconst { selector, attribute, regex } = totalElementConfig;\n\t\t\tlet totalElement;\n\t\t\t// handle case, when there is array of selectors and we try to take totalElement using these selectors in turn\n\t\t\t// for example dell.com, hertz.com\n\t\t\tif (Array.isArray(selector)) {\n\t\t\t\tselector.forEach(elemSelector => {\n\t\t\t\t\tif (!totalElement) {\n\t\t\t\t\t\ttotalElement = document.querySelector(elemSelector);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else if (typeof selector === 'string') {\n\t\t\t\ttotalElement = document.querySelector(selector);\n\t\t\t} else {\n\t\t\t\thandleDriverError(\n\t\t\t\t\tnew Error(`Total selector type mismatch. Expected string | array, got ${typeof selector}`),\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tif (totalElement) {\n\t\t\t\tlet value = attribute ? totalElement.getAttribute(attribute) : totalElement.textContent;\n\n\t\t\t\tif (value && regex) {\n\t\t\t\t\t// Set pattern to null to receive error in case pattern was not defined\n\t\t\t\t\t// otherwise we may silently return undefined or empty string\n\t\t\t\t\tconst { pattern = null, group = 0 } = regex;\n\t\t\t\t\tvalue = value.match(pattern)[group];\n\t\t\t\t}\n\t\t\t\tstartPrice = toFloat(value);\n\t\t\t}\n\t\t}\n\t\treturn startPrice;\n\t}\n\n\t/**\n\t * Perform any needed actions and setup to start codes testing\n\t *\n\t * @function beforeTestCodes\n\t *\n\t * @returns {Promise}\n\t */\n\tbeforeTestCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @typedef {Object} OriginalData\n\t * @property {Number} originalPrice the starting price for the cart\n\t * @property {Number} originalItemsCount the starting items count of the cart\n\t */\n\t/**\n\t * Perform any needed actions and setup before `checkCodes()` will be executed\n\t *\n\t * @function beforeCheckCodes\n\t * @param {Number} [originalPrice] - optional, the starting price for the cart\n\t * @param {Number} [originalItemsCount] - optional, the starting items count of the cart\n\t * @returns {Promise.<Number>|Promise.<OriginalData>} - optional, a promise which resolves to the original price of the cart\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\t\tor original data which includes originalItemsCount as well\n\t */\n\tbeforeCheckCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Perform any needed actions and setup before `applyCodes()` will be executed\n\t *\n\t * @function beforeApplyCodes\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tbeforeApplyCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function checkCodes\n\t *\n\t * @param {String[]} codes\n\t * @param {Number} [originalPrice] - optional, the starting price for the cart\n\t * @param {Number} [originalItemsCount] - optional, the starting items count of the cart\n\t * @returns {Promise}\n\t */\n\tcheckCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Takes each code in @param codes and actually applies it to the cart,\n\t * typically through a fetch(...) call.\n\t *\n\t * @function applyCodes\n\t *\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tapplyCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function stackCodes\n\t *\n\t * @param {Object} validationInfo - contains all required info passed by `checkCodes()` for codes stacking\n\t * @param {String[]} validationInfo.codes\n\t * @param {Float} [validationInfo.originalPrice]\n\t * @param {Object[]} [validationInfo.discounts] - contains all codes mapped with their discounts\n\t * @returns {Promise}\n\t */\n\tstackCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function removeCodes\n\t *\n\t * @param {String[]} codes - passed in case the driver needs to know specific codes to do removal\n\t * @returns {Promise.<Number>|Promise.<OriginalData>} - optional, a promise which resolves to the original price of the cart\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\t\tor original data which includes originalItemsCount as well\n\t */\n\tremoveCodes() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * Takes codes from merchant page (or request response) which are available and were not applied by user\n\t *\n\t * @function getMerchantCodes\n\t * @returns {String[]} - codes from merhcant page (or request response if possible)\n\t */\n\tgetMerchantCodes() {\n\t\treturn [];\n\t}\n\n\t/**\n\t * Takes codes from merchant page (or request) which are available and were applied by user\n\t *\n\t * @typedef {Object} ExistingCodeInfo\n\t * @prop {String[]} codes - list of codes which had been applied, if discoverable\n\t * @prop {Number} codeCount - the number of codes that were applied to the cart\n\t */\n\t/**\n\t * @function getExistingCodes\n\t * @returns {ExistingCodeInfo}\n\t */\n\tgetExistingCodes() {\n\t\treturn {\n\t\t\tcodes: [],\n\t\t\tcodeCount: 0,\n\t\t};\n\t}\n\n\t/**\n\t * Parses pre tax and shipping total from page or request's response\n\t *\n\t * @function getPreTaxShippingTotal\n\t * @returns {Promise<Number>|Number} - the total without tax and shipping\n\t */\n\tgetPreTaxShippingTotal() {\n\t\treturn null;\n\t}\n\n\t/**\n\t * @function watchForCartUrl - optional function to set up a listener for url changes on SPAs\n\t * @emits bus#CartActive - the event (using the string 'cart-active') that indicates to the app that test codes button should be shown\n\t * @emits bus#CartInactive - the event (using the string 'cart-inactive') that indicates to the app that test codes button should be hidden\n\t */\n\twatchForCartUrl(time = 500) {\n\t\tlet previousState = null;\n\t\tlet pauseInterval = false;\n\n\t\tconst interval = setInterval(async () => {\n\t\t\tif (!pauseInterval) {\n\t\t\t\tlet currentState = null;\n\t\t\t\ttry {\n\t\t\t\t\t// Pause interval to avoid triggering multiple times `checkCondition`\n\t\t\t\t\t// before the response will be received\n\t\t\t\t\tpauseInterval = true;\n\t\t\t\t\tcurrentState = await this.checkCondition();\n\t\t\t\t\tpauseInterval = false;\n\t\t\t\t} catch (e) {\n\t\t\t\t\thandleDriverError(e, { source: 'checkCondition' });\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t}\n\t\t\t\tif (currentState !== previousState) {\n\t\t\t\t\tbus.$emit(currentState ? 'cart-active' : 'cart-inactive');\n\t\t\t\t}\n\t\t\t\tpreviousState = currentState;\n\t\t\t}\n\t\t}, time);\n\t\t// return the interval to stop it in `watchForCartUrl` if needed from outside\n\t\treturn interval;\n\t}\n\n\t/**\n\t * @function checkCondition - optional function to check for conditions on SPAs\n\t * @returns {Boolean}\n\t */\n\tcheckCondition() {\n\t\treturn false;\n\t}\n\n\t/**\n\t * Perform custom completion action on Continue to Checkout button\n\t * Takes best codes in @param codes\n\t *\n\t * @function completeExperience\n\t *\n\t * @param {String[]} codes\n\t * @returns {Promise}\n\t */\n\tcompleteExperience() {\n\t\treturn Promise.resolve();\n\t}\n\n\t/**\n\t * @function completeExperiencePromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tcompleteExperiencePromisified(...args) {\n\t\treturn this._promisify(this.completeExperience, args);\n\t}\n\n\t/**\n\t * @function beforeCodesTestingPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeTestCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeTestCodes, args);\n\t}\n\n\t/**\n\t * @function getStartPricePromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetStartPricePromisified() {\n\t\treturn this._promisify(this.getStartPrice);\n\t}\n\n\t/**\n\t * @function getMerchantCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetMerchantCodesPromisified(...args) {\n\t\treturn this._promisify(this.getMerchantCodes, args);\n\t}\n\n\t/**\n\t * @function getExistingCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tgetExistingCodesPromisified(...args) {\n\t\treturn this._promisify(this.getExistingCodes, args);\n\t}\n\n\t/**\n\t * @function removeCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tremoveCodesPromisified(...args) {\n\t\treturn this._promisify(this.removeCodes, args);\n\t}\n\n\t/**\n\t * @function beforeApplyCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeApplyCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeApplyCodes, args);\n\t}\n\n\t/**\n\t * @function applyCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tapplyCodesPromisified(...args) {\n\t\treturn this._promisify(this.applyCodes, args);\n\t}\n\n\t/**\n\t * @function beforeCheckCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tbeforeCheckCodesPromisified(...args) {\n\t\treturn this._promisify(this.beforeCheckCodes, args);\n\t}\n\n\t/**\n\t * @function checkCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tcheckCodesPromisified(...args) {\n\t\treturn this._promisify(this.checkCodes, args);\n\t}\n\n\t/**\n\t * @function stackCodesPromisified - promisified wrapper function to guarantee that Promise will be returned (or exception from Promise)\n\t * @returns {Promise}\n\t */\n\tstackCodesPromisified(...args) {\n\t\treturn this._promisify(this.stackCodes, args);\n\t}\n\n\t/**\n\t * @function _promisify - promisifies given method and return it's result as a Promise\n\t * @returns {Promise}\n\t */\n\t_promisify(method, args) {\n\t\treturn Promise.resolve().then(() => method.apply(this, args));\n\t}\n}\n","import Promise from 'bluebird';\nimport BaseDriver from '../base';\nimport bus from '../../bus';\nimport { DOM, format, log } from '../../../utils';\nimport { isOnCartPage } from './_common';\n\nconst { extractFormValues } = DOM;\nconst { toFloat } = format;\n\nexport default class Driver extends BaseDriver {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.APPLY_BUTTON_SELECTOR = '.checkout-sidebar form[name=\"coupon\"] .btn[type=\"submit\"]';\n\t\tthis.CODES_SELECTOR = '#sb-discounts [id^=\"promo\"], .coupon-item [data-review-info-id]';\n\t\tthis.CODE_INPUT_SELECTOR = '#order-summary-promo-code';\n\t\tthis.COUPON_FORM_SELECTOR = 'form[name=\"couponForm\"], form[name=\"coupon\"]';\n\t\tthis.TOTAL_SELECTOR = '#sb-sum-total .sb-price, .summary-total [data-review-info=\"orderTotal\"]';\n\n\t\tthis.REMOVE_URL = '';\n\t\tthis.SHIPPING_SECTION_OPENED_SELECTOR = '#checkout-shipping-address.editing';\n\t\tthis.SHIPPING_OPTION_OPENED_SELECTOR = '#checkout-shipping-options.editing';\n\t\tthis.CART_EMPTY_SELECTOR = '.sb-cart-empty-promo';\n\t}\n\n\tcheckCondition() {\n\t\tconst { href } = window.location;\n\t\tconst isCart = href.includes('/checkout/cart.jsp');\n\t\tconst isCheckout = href.includes('/checkout/checkout.jsp');\n\t\tconst isCartEmpty = document.querySelector(this.CART_EMPTY_SELECTOR);\n\t\tconst isShippingStep = document.querySelector(this.SHIPPING_SECTION_OPENED_SELECTOR);\n\t\tconst isShippingOption = document.querySelector(this.SHIPPING_OPTION_OPENED_SELECTOR);\n\t\treturn (\n\t\t\t(isCart && isCartEmpty && !isCartEmpty.offsetParent) || (isCheckout && !isShippingStep && !isShippingOption)\n\t\t);\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.COUPON_APPLY_PARAM_NAME = this._isOnCartPage()\n\t\t\t? 'claimCodeField'\n\t\t\t: '/atg/commerce/promotion/CouponFormHandler.couponClaimCode';\n\n\t\tthis.requestData = extractFormValues(this.COUPON_FORM_SELECTOR);\n\n\t\tthis.removeQueryParams = new URLSearchParams({\n\t\t\ttask: 'remPromo',\n\t\t\treprice: true,\n\t\t\t_DARGS: '/store/common/checkout/cart.jsp_A',\n\t\t\t_dynSessConf: this.requestData.params.get('_dynSessConf'),\n\t\t});\n\t}\n\n\tgetExistingCodes() {\n\t\tconst codes = new Set(\n\t\t\t[...document.querySelectorAll(this.CODES_SELECTOR)]\n\t\t\t\t.map(element => {\n\t\t\t\t\tif (this._isOnCartPage()) {\n\t\t\t\t\t\t// id contains promo code in format `promo<code>-<discount>`\n\t\t\t\t\t\treturn element.id.split('-')[0].replace('promo', '');\n\t\t\t\t\t}\n\t\t\t\t\treturn element.getAttribute('data-review-info-id');\n\t\t\t\t})\n\t\t\t\t.filter(code => !code.includes('formError')),\n\t\t);\n\n\t\treturn {\n\t\t\tcodes: [...codes],\n\t\t\tcodeCount: codes.size,\n\t\t};\n\t}\n\n\tremoveCodes(codes) {\n\t\tlet lastResponse = null;\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis.removeCode(code, this.requestData).then(responseJSON => {\n\t\t\t\tlastResponse = responseJSON;\n\t\t\t}),\n\t\t).then(() => this.parseTotal(lastResponse));\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\t\tconst workingDiscounts = [];\n\t\treturn Promise.each(codes, code =>\n\t\t\tthis.applyCode(code).then(responseJSON => {\n\t\t\t\tconst finalPrice = this.parseTotal(responseJSON);\n\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\t\t\t\tconst isValid = this._isValidCode(responseJSON);\n\t\t\t\tconst result = { code, finalPrice, finalDiscount, isValid };\n\n\t\t\t\tif (finalPrice < originalPrice) {\n\t\t\t\t\tworkingDiscounts.push(result);\n\t\t\t\t}\n\n\t\t\t\treturn this.removeCode(code).then(() => bus.$emit('code-checked', result));\n\t\t\t}),\n\t\t).then(() =>\n\t\t\tbus.$emit('stack-codes', {\n\t\t\t\tcodes: workingDiscounts.map(discount => discount.code),\n\t\t\t\tdiscounts: workingDiscounts,\n\t\t\t\toriginalPrice,\n\t\t\t}),\n\t\t);\n\t}\n\n\tstackCodes(validationInfo) {\n\t\tconst workingDiscounts = validationInfo.discounts;\n\t\tconst { originalPrice } = validationInfo;\n\n\t\t// Sort by discount\n\t\tworkingDiscounts.sort((a, b) => b.finalDiscount - a.finalDiscount);\n\n\t\tlet currentPrice = originalPrice;\n\t\tlet currentDiscount = 0;\n\t\tconst successfulCodes = [];\n\n\t\treturn Promise.each(workingDiscounts, discount =>\n\t\t\tthis.applyCode(discount.code).then(responseJSON => {\n\t\t\t\tconst finalPrice = this.parseTotal(responseJSON);\n\t\t\t\tconst finalDiscount = originalPrice - finalPrice;\n\n\t\t\t\tbus.$emit('code-stacked', {\n\t\t\t\t\tcode: discount.code,\n\t\t\t\t\tfinalPrice,\n\t\t\t\t\tfinalDiscount,\n\t\t\t\t});\n\n\t\t\t\tif (finalPrice < currentPrice) {\n\t\t\t\t\tsuccessfulCodes.push(discount.code);\n\t\t\t\t\tcurrentDiscount = finalDiscount;\n\t\t\t\t\tcurrentPrice = finalPrice;\n\t\t\t\t}\n\t\t\t\t// Discount won't be applied if it has conflict with already applied discounts\n\t\t\t\treturn Promise.resolve();\n\t\t\t}),\n\t\t).then(() =>\n\t\t\tbus.$emit('stackable-complete', {\n\t\t\t\tcodes: successfulCodes,\n\t\t\t\tfinalPrice: currentPrice,\n\t\t\t\tfinalDiscount: currentDiscount,\n\t\t\t}),\n\t\t);\n\t}\n\n\tapplyCode(code) {\n\t\tthis.requestData.params.set(this.COUPON_APPLY_PARAM_NAME, code);\n\n\t\treturn fetch(this.requestData.action, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\theaders: {\n\t\t\t\tAccept: 'application/json, text/javascript, */*',\n\t\t\t\t'X-Requested-With': 'XMLHttpRequest',\n\t\t\t},\n\t\t\tbody: this.requestData.params,\n\t\t}).then(response => response.json());\n\t}\n\n\tremoveCode(code) {\n\t\tthis.removeQueryParams.set('_DAV', code);\n\t\tthis.removeQueryParams.set('_', Date.now());\n\n\t\treturn fetch(`${this.REMOVE_URL}?${this.removeQueryParams.toString()}`, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.json());\n\t}\n\n\tparseTotal(dataJSON) {\n\t\tlet total = null;\n\t\tif (dataJSON) {\n\t\t\tif (this._isOnCartPage()) {\n\t\t\t\t// On cart page shipping is not included\n\t\t\t\ttotal = dataJSON.subtotal;\n\t\t\t} else {\n\t\t\t\t// For apply and remove on checkout we have different format\n\t\t\t\ttotal = dataJSON.order ? dataJSON.order.orderDetails.orderTotal : dataJSON.udsItemsTotal;\n\t\t\t}\n\t\t} else {\n\t\t\ttotal = document.querySelector(this.TOTAL_SELECTOR).innerText;\n\t\t}\n\n\t\treturn toFloat(total);\n\t}\n\n\t_isValidCode(dataJSON) {\n\t\tif (this._isOnCartPage()) {\n\t\t\treturn !dataJSON.formErrors.coupon.length;\n\t\t}\n\t\treturn !dataJSON.order.coupon.formErrors.length;\n\t}\n\n\t_isOnCartPage() {\n\t\treturn isOnCartPage();\n\t}\n}\n","const isOnCartPage = () => window.location.pathname.includes('/cart.jsp');\nconst isOnCartUrl = href => href.includes('/checkout/cart.jsp') || href.includes('/checkout/checkout.jsp');\n\nexport { isOnCartPage, isOnCartUrl };\n","import soma from './soma.com';\nimport whitehouseblackmarket from './whitehouseblackmarket.com';\n\nexport default [soma, whitehouseblackmarket];\n","import DriverTemplate from './_base';\nimport { elemToFloat } from '../../../utils/format';\nimport { extractElement } from '../../../utils/DOM';\n/**\n * Driver behavior description:\n -    Existing code: yes\n -    Remove code: yes\n -    Stackable: yes\n -    Free gift support: no\n -    ‘isValid’ implemented: yes\n Optional:\n -    Show message about free shipping on the cart page (without discount info): no\n -    Is driver SPA and add the condition to show popup: yes (cart and checkout pages)\n */\nconst Driver = class Driver extends DriverTemplate {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.REMOVE_URL = 'https://www.soma.com/store/common/json/cart.jsp';\n\t\tthis.CHARGES_REGEX = /(shipping|tax|handling)/i;\n\t\tthis.CHARGES_SELECTOR = 'section[data-checkout-module=\"orderDetails\"]:first-child div .text-right';\n\t}\n\n\tasync getPreTaxShippingTotal() {\n\t\tif (window.location.href.includes('/checkout/cart.jsp')) {\n\t\t\tconst cartJSON = await this.applyCode('fake');\n\t\t\tconst total = this.parseTotal(cartJSON);\n\t\t\treturn total;\n\t\t}\n\t\tconst cartStr = await this._getUpdatedCart();\n\t\tconst total = elemToFloat(extractElement(this.TOTAL_SELECTOR, cartStr));\n\t\tconst taxes = [...extractElement(this.CHARGES_SELECTOR, cartStr, true)]\n\t\t\t.filter(el => el.parentElement.textContent.match(this.CHARGES_REGEX))\n\t\t\t.map(elemToFloat)\n\t\t\t.filter(Boolean)\n\t\t\t.reduce((charges, charge) => charges + charge, 0); // shipping & tax might not be counted on checkout\n\t\treturn total - taxes;\n\t}\n\n\t_getUpdatedCart() {\n\t\treturn fetch(window.location.href, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n};\n\nexport default {\n\tname: 'Soma',\n\tdomain: 'soma.com',\n\tstackable: true,\n\tisSinglePageApp: true,\n\tDriver,\n};\n","import Promise from 'bluebird';\nimport DriverTemplate from './_base';\nimport { sessionTimer } from '../../lib';\nimport bus from '../../bus';\nimport { DOM, format, log, sendXhr, browserUtils } from '../../../utils';\n\nconst { elemToFloat, toFloat } = format;\nconst { extractElement, extractFormValues } = DOM;\nconst { getCookie } = browserUtils;\n\n/* Behavior description:\n\t- Existing code: yes\n\t- Remove code: yes\n\t- Is SPA: yes\n\t- isStackable: yes\n\t- Free gift support: no\n\t- 'isValid' implemented: yes\n\t- Works on: Cart, Payment\n\t- Max coupons: 12\n\t- Gather codes on site pages: yes (cart page)\n\n\tSpecial case:\n\tuser can add donation to cart\n\ton Payment page we don't test codes, when there are only donation items in cart\n\ton Cart page we don't show \"Apply codes\" button when there are only donation items in cart\n\n\ton checkout page there are cases, when we get response with total without taxes. Can't find the reason of it (all headers and other parameters are equal)\n\tso we make a check whether taxes are calculated, and send get request to get valid total\n\n\t*/\n\nconst Driver = class Driver extends DriverTemplate {\n\tconstructor() {\n\t\tsuper();\n\t\tthis.REMOVE_URL = 'https://www.whitehouseblackmarket.com/store/common/json/cart.jsp';\n\t\tthis.CHARGES_REGEX = /(shipping|tax)/i;\n\t\tthis.CHARGES_SELECTOR = 'section[data-checkout-module=\"orderDetails\"]:first-child div .text-right';\n\t\tsessionTimer.initialize({\n\t\t\tactionInterval: null,\n\t\t\ttimeout: 15,\n\t\t});\n\t\tthis.REMOVE_FORM_SELECTOR = 'form[name=\"couponRemove\"]';\n\t\tthis.REMOVE_PARAM_NAME = '/atg/commerce/promotion/CouponFormHandler.unClaimCoupon';\n\t\tthis.CART_ITEMS_SELECTOR = 'a.bluelink';\n\t\tthis.CART_ITEMS_REGEXP = /catId=(\\w+)/;\n\t\tthis.MERCHANT_CODES_SELECTOR = '#header-promo-toggle [data-toggle=\"header-promo\"]';\n\t\tthis.MERCHANT_CODES_REGEXP = /use code: (\\w+)/i;\n\t\tthis.isItemsInCart = true;\n\t}\n\n\tcheckCondition() {\n\t\tconst { href } = window.location;\n\t\tconst isCart = href.includes('/checkout/cart.jsp');\n\t\tconst isCheckout = href.includes('/checkout/checkout.jsp');\n\t\tconst isItemsInCart = [...document.querySelectorAll(this.CART_ITEMS_SELECTOR)]\n\t\t\t.map(element => element.getAttribute('href').match(this.CART_ITEMS_REGEXP))\n\t\t\t.filter(Boolean).length;\n\t\tconst isUSAChosen = getCookie('userCountry') === 'USA';\n\t\tconst isShippingStep = document.querySelector(this.SHIPPING_SECTION_OPENED_SELECTOR);\n\t\tconst isShippingOption = document.querySelector(this.SHIPPING_OPTION_OPENED_SELECTOR);\n\t\tconst totalElement = document.querySelector(this.TOTAL_SELECTOR);\n\t\tconst isTotal = totalElement && !!totalElement.textContent;\n\t\tconst isDollar = isTotal && totalElement.innerText.startsWith('$');\n\t\treturn (\n\t\t\tisUSAChosen &&\n\t\t\tisDollar &&\n\t\t\t((isItemsInCart && isCart && isTotal) || (isCheckout && !isShippingStep && !isShippingOption && isTotal))\n\t\t);\n\t}\n\n\tgetMerchantCodes() {\n\t\treturn this._getUpdatedCart().then(() => {\n\t\t\tconst codes = [...document.querySelectorAll(this.MERCHANT_CODES_SELECTOR)]\n\t\t\t\t.map(el => el.textContent.match(this.MERCHANT_CODES_REGEXP))\n\t\t\t\t.filter(Boolean)\n\t\t\t\t.map(el => el[1]);\n\n\t\t\treturn [...new Set(codes)];\n\t\t});\n\t}\n\n\tbeforeTestCodes() {\n\t\tthis.COUPON_APPLY_PARAM_NAME = this._isOnCartPage()\n\t\t\t? 'claimCodeField'\n\t\t\t: '/atg/commerce/promotion/CouponFormHandler.couponClaimCode';\n\t\tthis.requestData = extractFormValues(this.COUPON_FORM_SELECTOR);\n\t\tif (this._isOnCartPage()) {\n\t\t\tthis.removeQueryParams = new URLSearchParams({\n\t\t\t\ttask: 'remPromo',\n\t\t\t\treprice: true,\n\t\t\t\t_DARGS: '/store/common/checkout/cart.jsp_A',\n\t\t\t\t_dynSessConf: this.requestData.params.get('_dynSessConf'),\n\t\t\t});\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tthis.removeRequestData = extractFormValues(this.REMOVE_FORM_SELECTOR);\n\t\treturn this.applyCode('fake').then(responseJson => {\n\t\t\tthis.isItemsInCart = responseJson.order.orderDetails.items.filter(\n\t\t\t\titem => item.isDonation === 'false',\n\t\t\t).length;\n\t\t\treturn Promise.resolve();\n\t\t});\n\t}\n\n\tbeforeCheckCodes(originalPrice) {\n\t\t// taxes may be not included in total(if donation was added before code testing), we have to get total with taxes\n\t\tif (!originalPrice && !this._isOnCartPage()) {\n\t\t\treturn this._getUpdatedCart().then(responseText => this.parseTotal(responseText));\n\t\t}\n\t\treturn originalPrice;\n\t}\n\n\tcheckCodes(codes, originalPrice = this.parseTotal()) {\n\t\tlog(`Original price: ${originalPrice}`);\n\t\tconst workingDiscounts = [];\n\n\t\treturn Promise.each(codes, code => {\n\t\t\tconst result = {\n\t\t\t\tcode,\n\t\t\t\tfinalPrice: originalPrice,\n\t\t\t\tfinalDiscount: 0,\n\t\t\t\tisValid: false,\n\t\t\t};\n\t\t\t// we don't test codes if only donation is in cart\n\t\t\tif (!this.isItemsInCart) {\n\t\t\t\treturn bus.$emit('code-checked', result);\n\t\t\t}\n\t\t\treturn this.applyCode(code).then(async responseJSON => {\n\t\t\t\tlet response = responseJSON;\n\t\t\t\tif (!this._isValidCode(responseJSON)) {\n\t\t\t\t\treturn bus.$emit('code-checked', result);\n\t\t\t\t}\n\t\t\t\tif (\n\t\t\t\t\t!this._isOnCartPage() &&\n\t\t\t\t\tresponseJSON.order &&\n\t\t\t\t\ttoFloat(responseJSON.order.orderDetails.USASalesTax) === 0\n\t\t\t\t) {\n\t\t\t\t\tresponse = await this._getUpdatedCart();\n\t\t\t\t}\n\t\t\t\tresult.finalPrice = this.parseTotal(response);\n\t\t\t\tresult.finalDiscount = originalPrice - result.finalPrice;\n\t\t\t\tresult.isValid = true;\n\n\t\t\t\tif (result.finalPrice < originalPrice) {\n\t\t\t\t\tworkingDiscounts.push(result);\n\t\t\t\t}\n\n\t\t\t\treturn new Promise(resolve => {\n\t\t\t\t\tif (!this.removeRequestData && !this._isOnCartPage()) {\n\t\t\t\t\t\treturn this._getUpdatedCart().then(responseText => {\n\t\t\t\t\t\t\tthis.removeRequestData = extractFormValues(this.REMOVE_FORM_SELECTOR, responseText);\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn resolve();\n\t\t\t\t})\n\t\t\t\t\t.then(() => this.removeCode(code))\n\t\t\t\t\t.then(() => bus.$emit('code-checked', result));\n\t\t\t});\n\t\t}).then(() =>\n\t\t\tbus.$emit('stack-codes', {\n\t\t\t\tcodes: workingDiscounts.map(discount => discount.code),\n\t\t\t\tdiscounts: workingDiscounts,\n\t\t\t\toriginalPrice,\n\t\t\t}),\n\t\t);\n\t}\n\n\tasync getPreTaxShippingTotal() {\n\t\tif (!this.isItemsInCart) {\n\t\t\treturn null;\n\t\t}\n\t\tconst cartJSON = await this.applyCode('fake');\n\t\t// different responses on cart and checkout pages\n\t\tconst donation = (cartJSON.order ? cartJSON.order.orderDetails.items : cartJSON.items)\n\t\t\t.filter(item => item.isDonation === 'true')\n\t\t\t.map(item => item.priceAfterDiscount || item.finalItemPrice)\n\t\t\t.reduce((a, b) => toFloat(a) + toFloat(b), 0);\n\t\tif (window.location.href.includes('/checkout/cart.jsp')) {\n\t\t\tconst total = this.parseTotal(cartJSON);\n\t\t\treturn total - donation;\n\t\t}\n\t\tconst cartStr = await this._getUpdatedCart();\n\t\tconst total = this.parseTotal(cartStr);\n\t\tconst taxes = [\n\t\t\t...new Set(\n\t\t\t\t[...extractElement(this.CHARGES_SELECTOR, cartStr, true)]\n\t\t\t\t\t.filter(el => el.parentElement.textContent.match(this.CHARGES_REGEX))\n\t\t\t\t\t.map(elemToFloat)\n\t\t\t\t\t.filter(Boolean),\n\t\t\t),\n\t\t].reduce((charges, charge) => charges + charge, 0); // shipping & tax might not be counted on checkout\n\t\treturn total - taxes - donation;\n\t}\n\n\tapplyCode(code) {\n\t\tthis.requestData.params.set(this.COUPON_APPLY_PARAM_NAME, code);\n\n\t\treturn this._manageCode(this.requestData);\n\t}\n\n\tremoveCode(code) {\n\t\tif (this._isOnCartPage()) {\n\t\t\treturn super.removeCode(code);\n\t\t}\n\n\t\tthis.removeRequestData.params.set(this.REMOVE_PARAM_NAME, code);\n\t\treturn this._manageCode(this.removeRequestData);\n\t}\n\n\t_manageCode(requestData) {\n\t\treturn sendXhr(requestData.action, {\n\t\t\tmethod: 'POST',\n\t\t\tcredentials: 'include',\n\t\t\theaders: {\n\t\t\t\tAccept: 'application/json, text/javascript, */*',\n\t\t\t\t'X-Requested-With': 'XMLHttpRequest',\n\t\t\t},\n\t\t\tbody: requestData.params,\n\t\t}).then(response => response.json());\n\t}\n\n\t_getUpdatedCart() {\n\t\treturn sendXhr(window.location.href, {\n\t\t\tmethod: 'GET',\n\t\t\tcredentials: 'include',\n\t\t}).then(response => response.text());\n\t}\n\n\tparseTotal(data) {\n\t\tlet total = null;\n\t\tif (typeof data === 'object') {\n\t\t\tif (this._isOnCartPage()) {\n\t\t\t\t// On cart page shipping is not included\n\t\t\t\ttotal = data.subtotal;\n\t\t\t} else {\n\t\t\t\t// For apply and remove on checkout we have different format\n\t\t\t\ttotal = data.order ? data.order.orderDetails.orderTotal : data.udsItemsTotal;\n\t\t\t}\n\t\t} else {\n\t\t\ttotal = extractElement(this.TOTAL_SELECTOR, data).textContent;\n\t\t}\n\n\t\treturn toFloat(total);\n\t}\n};\n\nexport default {\n\tname: 'White House Black Market',\n\tdomain: 'whitehouseblackmarket.com',\n\tmaxCoupons: 12,\n\tstackable: true,\n\tisSinglePageApp: true,\n\tDriver,\n};\n"],"sourceRoot":""}